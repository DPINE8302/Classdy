
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classdy</title>
    <meta name="description" content="Classdy: Your new intelligent attendance and schedule assistant.">
    <meta name="theme-color" content="#f4f5f7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#18181b" media="(prefers-color-scheme: dark)">
    
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root {
        --color-primary: rgb(0 122 255);
        --color-primary-hover: rgb(0 100 225);
        --color-primary-rgb: 0, 122, 255;
      }

      /* Custom scrollbar for a more modern look */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background-color: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background-color: rgba(128, 128, 128, 0.3);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      ::-webkit-scrollbar-thumb:hover {
        background-color: rgba(128, 128, 128, 0.5);
      }
      .dark ::-webkit-scrollbar-thumb {
         background-color: rgba(255, 255, 255, 0.2);
      }
      .dark ::-webkit-scrollbar-thumb:hover {
         background-color: rgba(255, 255, 255, 0.3);
      }
    </style>
    <script>
      // Flash of unstyled content (FOUC) prevention
      const settingsRaw = localStorage.getItem('classdy-settings');
      const theme = settingsRaw ? JSON.parse(settingsRaw).theme : 'system';
      if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }

      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              primary: {
                DEFAULT: 'var(--color-primary)',
                hover: 'var(--color-primary-hover)'
              },
              success: { DEFAULT: '#34C759', dark: '#30A14F' },
              warning: { DEFAULT: '#FF9500', dark: '#D97E00' },
              danger: { DEFAULT: '#FF3B30', dark: '#D93229' },
              holiday: { DEFAULT: '#5856D6', dark: '#6A67F0'},
              info: { DEFAULT: '#8E8E93' }, // Neutral info color
            },
            borderRadius: {
              'xl': '1rem',
              '2xl': '1.25rem',
            },
            boxShadow: {
              'soft': '0 1px 3px rgba(0, 0, 0, 0.05), 0 2px 8px rgba(0, 0, 0, 0.05)',
              'soft-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.1)',
            },
            animation: {
                'fade-in': 'fadeIn 0.2s ease-out forwards',
            },
            keyframes: {
                fadeIn: {
                    '0%': { opacity: 0, transform: 'translateY(10px) scale(0.98)' },
                    '100%': { opacity: 1, transform: 'translateY(0) scale(1)' },
                },
            },
          }
        }
      }
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/client": "https://esm.sh/react-dom@^19.1.0/client",
    "lucide-react": "https://esm.sh/lucide-react@^0.525.0",
    "date-fns": "https://esm.sh/date-fns@^4.1.0",
    "recharts": "https://esm.sh/recharts@^3.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "vite": "https://esm.sh/vite@^7.0.4",
    "path": "https://esm.sh/path@^0.12.7"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-zinc-100 dark:bg-zinc-900 font-sans text-zinc-900 dark:text-zinc-50 antialiased">
    <div id="root"></div>
    <script type="module">
      import React, { useState, useMemo, useEffect, useCallback, forwardRef, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { Settings as SettingsIcon, LayoutGrid, ListChecks, AreaChart, BarChartHorizontal, MessageCircle, Plus, Trash2, Edit, SlidersHorizontal, Palette, Calendar, Database, Bell, List, ChevronRight, NotebookText, Bot, User, Send, MessageSquareText, PlusCircle, HelpCircle, Award, Coffee, Meh, CheckCircle, AlertCircle, XCircle, CalendarDays, TrendingUp, Clock, Sunrise, Sunset, X } from 'lucide-react';
      import { parse, addMinutes, isAfter, isBefore, isEqual, differenceInMinutes, getDay, format, startOfDay, subDays, parseISO, isWithinInterval, startOfWeek, endOfWeek, eachDayOfInterval, startOfMonth, endOfMonth, addMonths } from 'date-fns';
      import { ResponsiveContainer, PieChart, Pie, Cell, Tooltip, AreaChart as RechartsAreaChart, Area as RechartsArea, XAxis, YAxis, CartesianGrid, Legend, ReferenceLine, BarChart, Bar, ComposedChart, Line, Dot } from 'recharts';
      
      // =================================================================================
      // TYPES
      // =================================================================================
      
      // type DayOfWeek = 0 | 1 | 2 | 3 | 4 | 5 | 6; // Sunday - Saturday
      // type Theme = 'light' | 'dark' | 'system';
      
      // interface Task {
      //   id: string;
      //   text: string;
      //   completed: boolean;
      // }
      
      // interface ClassSession {
      //   id: string;
      //   subject: string;
      //   startTime: string; // HH:mm
      //   endTime: string; // HH:mm
      //   tasks: Task[];
      //   isOnline?: boolean;
      // }
      
      // interface ScheduleRule {
      //   dayOfWeek: DayOfWeek;
      //   classes: ClassSession[];
      // }
      
      // interface Schedule {
      //   id:string;
      //   name: string;
      //   rules: ScheduleRule[];
      //   startDate?: string; // YYYY-MM-DD format
      //   endDate?: string; // YYYY-MM-DD format
      // }
      
      // interface Settings {
      //   gracePeriod: number; // in minutes
      //   theme: Theme;
      //   accentColor: string;
      //   notificationsEnabled: boolean;
      //   assistantName?: string;
      // }
      
      // interface Holiday {
      //   date: string; // YYYY-MM-DD
      //   name: string;
      // }
      
      // interface AttendanceLog {
      //   id: string; // YYYY-MM-DD
      //   date: string; // YYYY-MM-DD
      //   arrivalTime: string | null; // HH:mm
      //   departureTime: string | null; // HH:mm
      //   statusTag?: 'Absent' | 'Holiday';
      // }
      
      // type AttendanceStatus = 'ON_TIME' | 'LATE' | 'EARLY' | 'DAY_OFF' | 'ABSENT' | 'HOLIDAY' | 'NO_ENTRY' | 'NO_SCHEDULE';
      
      // type SubjectMeta = Record<string, {
      //     color: string;
      //     icon?: string;
      // }>;
      
      // =================================================================================
      // CONSTANTS
      // =================================================================================
      
      const DAYS_OF_WEEK = [
        { value: 1, label: 'Monday' },
        { value: 2, label: 'Tuesday' },
        { value: 3, label: 'Wednesday' },
        { value: 4, label: 'Thursday' },
        { value: 5, label: 'Friday' },
        { value: 6, label: 'Saturday' },
        { value: 0, label: 'Sunday' },
      ];
      
      const scheduleYear = 2025;
      
      const INITIAL_SCHEDULES = [
        {
          id: `semester-1-${scheduleYear}`,
          name: 'Semester 1',
          startDate: `${scheduleYear}-06-09`,
          endDate: `${scheduleYear}-10-10`,
          rules: [
            { dayOfWeek: 1, classes: [
                { id: 'sem1-mon-1', subject: 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)', startTime: '08:15', endTime: '09:45', tasks: [], isOnline: true },
            ]},
            { dayOfWeek: 2, classes: [
                { id: 'sem1-tue-1', subject: 'Homeroom', startTime: '07:45', endTime: '08:15', tasks: [] },
                { id: 'sem1-tue-2', subject: 'à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²7', startTime: '08:15', endTime: '09:00', tasks: [] },
                { id: 'sem1-tue-3', subject: 'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7', startTime: '09:00', endTime: '09:45', tasks: [] },
                { id: 'sem1-tue-4', subject: 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢', startTime: '09:50', endTime: '11:20', tasks: [] },
                { id: 'sem1-tue-5', subject: 'à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡-à¸žà¸¹à¸”à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ 1', startTime: '12:55', endTime: '14:25', tasks: [] },
                { id: 'sem1-tue-6', subject: 'à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© 7', startTime: '14:30', endTime: '16:00', tasks: [] },
            ]},
            { dayOfWeek: 3, classes: [
                { id: 'sem1-wed-1', subject: 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)', startTime: '08:15', endTime: '09:25', tasks: [], isOnline: true },
                { id: 'sem1-wed-2', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7', startTime: '09:30', endTime: '11:20', tasks: [] },
                { id: 'sem1-wed-3', subject: 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1', startTime: '12:55', endTime: '14:25', tasks: [] },
                { id: 'sem1-wed-4', subject: 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1', startTime: '14:30', endTime: '16:00', tasks: [] },
            ]},
            { dayOfWeek: 4, classes: [
                { id: 'sem1-thu-1', subject: 'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)', startTime: '08:15', endTime: '09:25', tasks: [], isOnline: true },
                { id: 'sem1-thu-2', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)', startTime: '09:30', endTime: '11:20', tasks: [] },
                { id: 'sem1-thu-3', subject: 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹à¸¥à¸°à¸ˆà¸´à¸•à¹ƒà¸ˆ', startTime: '12:55', endTime: '13:40', tasks: [] },
                { id: 'sem1-thu-4', subject: 'à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', startTime: '13:40', endTime: '16:00', tasks: [] },
            ]},
            { dayOfWeek: 5, classes: [
                { id: 'sem1-fri-0', subject: 'Homeroom', startTime: '07:45', endTime: '08:15', tasks: [] },
                { id: 'sem1-fri-1', subject: 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 7', startTime: '08:15', endTime: '09:45', tasks: [] },
                { id: 'sem1-fri-2', subject: 'à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸² à¸¨à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡ 7', startTime: '09:50', endTime: '11:20', tasks: [] },
                { id: 'sem1-fri-3', subject: 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1', startTime: '12:55', endTime: '14:25', tasks: [] },
                { id: 'sem1-fri-4', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)', startTime: '14:30', endTime: '16:00', tasks: [] },
            ]},
            { dayOfWeek: 6, classes: [] },
            { dayOfWeek: 0, classes: [] },
          ]
        },
        {
          id: `semester-2-${scheduleYear}`,
          name: 'Semester 2',
          startDate: `2025-10-14`,
          endDate: `2026-03-03`,
          rules: [
            { dayOfWeek: 1, classes: [
                { id: 's2-mon-1', subject: 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)', startTime: '08:15', endTime: '09:45', tasks: [] },
                { id: 's2-mon-2', subject: 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™', startTime: '09:50', endTime: '16:00', tasks: [] },
            ]},
            { dayOfWeek: 2, classes: [
                { id: 's2-tue-1', subject: 'Homeroom', startTime: '07:45', endTime: '08:15', tasks: [] },
                { id: 's2-tue-2', subject: 'à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²7', startTime: '08:15', endTime: '09:00', tasks: [] },
                { id: 's2-tue-3', subject: 'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7', startTime: '09:00', endTime: '09:45', tasks: [] },
                { id: 's2-tue-4', subject: 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢', startTime: '09:50', endTime: '11:20', tasks: [] },
            ]},
            { dayOfWeek: 3, classes: [
                { id: 's2-wed-1', subject: 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)', startTime: '08:15', endTime: '09:45', tasks: [] },
                { id: 's2-wed-2', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7', startTime: '09:50', endTime: '11:20', tasks: [] },
                { id: 's2-wed-3', subject: 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1', startTime: '12:55', endTime: '14:25', tasks: [] },
            ]},
            { dayOfWeek: 4, classes: [
                { id: 's2-thu-1', subject: 'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)', startTime: '08:15', endTime: '09:45', tasks: [] },
                { id: 's2-thu-2', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)', startTime: '09:50', endTime: '11:20', tasks: [] },
                { id: 's2-thu-3', subject: 'à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', startTime: '13:40', endTime: '16:00', tasks: [] },
            ]},
            { dayOfWeek: 5, classes: [
                { id: 's2-fri-1', subject: 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 7', startTime: '08:15', endTime: '09:45', tasks: [] },
                { id: 's2-fri-2', subject: 'à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸² à¸¨à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡ 7', startTime: '09:50', endTime: '11:20', tasks: [] },
                { id: 's2-fri-3', subject: 'à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡-à¸žà¸¹à¸”à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ 1', startTime: '12:55', endTime: '14:25', tasks: [] },
            ]},
            { dayOfWeek: 6, classes: [] },
            { dayOfWeek: 0, classes: [] },
          ]
        },
        {
          id: `summer-break-${scheduleYear}`,
          name: 'Summer Break',
          startDate: `${scheduleYear}-04-02`, 
          endDate: `${scheduleYear}-05-02`,
          rules: [
              { dayOfWeek: 1, classes: [{ id: 'sum-mon', subject: 'Summer Session', startTime: '07:45', endTime: '15:00', tasks: [] }] },
              { dayOfWeek: 2, classes: [{ id: 'sum-tue', subject: 'Summer Session', startTime: '07:45', endTime: '15:00', tasks: [] }] },
              { dayOfWeek: 3, classes: [{ id: 'sum-wed', subject: 'Summer Session', startTime: '07:45', endTime: '15:00', tasks: [] }] },
              { dayOfWeek: 4, classes: [{ id: 'sum-thu', subject: 'Summer Session', startTime: '07:45', endTime: '15:00', tasks: [] }] },
              { dayOfWeek: 5, classes: [{ id: 'sum-fri', subject: 'Summer Session', startTime: '07:45', endTime: '15:00', tasks: [] }] },
              { dayOfWeek: 6, classes: [] },
              { dayOfWeek: 0, classes: [] },
          ]
        },
      ];
      
      const DEFAULT_SETTINGS = {
        gracePeriod: 5,
        theme: 'system',
        accentColor: '#007AFF', // Apple Blue
        notificationsEnabled: false,
        assistantName: 'Bros',
      };
      
      const INITIAL_SUBJECT_META = {
          'Homeroom': { color: '#778899', icon: 'ðŸ ' },
          'Summer Session': { color: '#FF9500', icon: 'â˜€ï¸' },
          'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™': { color: '#829494', icon: 'ðŸŒ±' },
          'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹à¸¥à¸°à¸ˆà¸´à¸•à¹ƒà¸ˆ': { color: '#c9b19e', icon: 'ðŸ§ ' },
          'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 7': { color: '#D2B48C', icon: 'ðŸ‡¹ðŸ‡­' },
          'à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡-à¸žà¸¹à¸”à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ 1': { color: '#BC8F8F', icon: 'ðŸ—£ï¸' },
          'à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© 7': { color: '#C7A27E', icon: 'ðŸ‡¬ðŸ‡§' },
          'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7': { color: '#6e8eac', icon: 'ðŸ§®' },
          'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)': { color: '#6e8eac', icon: 'ðŸ“ˆ' },
          'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1': { color: '#456882', icon: 'ðŸ”¬' },
          'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)': { color: '#D2B48C', icon: 'ðŸ“œ' },
          'à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸² à¸¨à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡ 7': { color: '#C7A27E', icon: 'ðŸŒ' },
          'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)': { color: '#d2c1b6', icon: 'ðŸŽµ' },
          'à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²7': { color: '#e0c1b6', icon: 'â¤ï¸' },
          'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7': { color: '#a9c0a6', icon: 'ðŸ€' },
          'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)': { color: '#9E7E76', icon: 'ðŸ’¼' },
          'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢': { color: '#c9b19e', icon: 'ðŸŽ¨' },
          'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1': { color: '#b6d2d6', icon: 'ðŸ–Œï¸' },
          'à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ': { color: '#9E7E76', icon: 'ðŸ’¡' },
          'History': { color: '#D2B48C', icon: 'ðŸ“œ' },
          'Student Development': { color: '#829494', icon: 'ðŸŒ±' },
          'Health': { color: '#e0c1b6', icon: 'â¤ï¸' },
          'Physical Education': { color: '#a9c0a6', icon: 'ðŸ€' },
          'Multimedia Design': { color: '#c9b19e', icon: 'ðŸŽ¨' },
          'English Communication': { color: '#BC8F8F', icon: 'ðŸ—£ï¸' },
          'English': { color: '#C7A27E', icon: 'ðŸ‡¬ðŸ‡§' },
          'Computer Science': { color: '#9E7E76', icon: 'ðŸ’»' },
          'Mathematics': { color: '#6e8eac', icon: 'ðŸ§®' },
          'Physical Science': { color: '#456882', icon: 'ðŸ”¬' },
          'Music': { color: '#d2c1b6', icon: 'ðŸŽµ' },
          'Advanced Mathematics': { color: '#6e8eac', icon: 'ðŸ“ˆ' },
          'Programming': { color: '#9E7E76', 'icon': 'ðŸ’¡' },
          'Thai Language': { color: '#D2B48C', icon: 'ðŸ‡¹ðŸ‡­' },
          'Social Studies': { color: '#C7A27E', icon: 'ðŸŒ' },
      };
      
      const INITIAL_LOGS = [
        { id: '2025-07-09', date: '2025-07-09', arrivalTime: '07:58', departureTime: null },
        { id: '2025-07-08', date: '2025-07-08', arrivalTime: '07:44', departureTime: null },
        { id: '2025-07-04', date: '2025-07-04', arrivalTime: '07:39', departureTime: null },
        { id: '2025-07-03', date: '2025-07-03', arrivalTime: '09:17', departureTime: null },
        { id: '2025-07-02', date: '2025-07-02', arrivalTime: '08:31', departureTime: null },
        { id: '2025-07-01', date: '2025-07-01', arrivalTime: '07:31', departureTime: null },
        { id: '2025-06-27', date: '2025-06-27', arrivalTime: '07:14', departureTime: null },
        { id: '2025-06-26', date: '2025-06-26', arrivalTime: '09:02', departureTime: null },
        { id: '2025-06-25', date: '2025-06-25', arrivalTime: '07:45', departureTime: null },
        { id: '2025-06-24', date: '2025-06-24', arrivalTime: '07:32', departureTime: null },
        { id: '2025-06-20', date: '2025-06-20', arrivalTime: '07:36', departureTime: null },
        { id: '2025-06-19', date: '2025-06-19', arrivalTime: '09:14', departureTime: null },
        { id: '2025-06-18', date: '2025-06-18', arrivalTime: '09:18', departureTime: null },
        { id: '2025-06-17', date: '2025-06-17', arrivalTime: '07:17', departureTime: null },
        { id: '2025-06-13', date: '2025-06-13', arrivalTime: '07:16', departureTime: null },
        { id: '2025-06-12', date: '2025-06-12', arrivalTime: '07:46', departureTime: null },
        { id: '2025-06-11', date: '2025-06-11', arrivalTime: '08:17', departureTime: null },
        { id: '2025-06-10', date: '2025-06-10', arrivalTime: '07:13', departureTime: null },
        { id: '2025-06-09', date: '2025-06-09', arrivalTime: '11:16', departureTime: null },
        { id: '2025-05-02', date: '2025-05-02', arrivalTime: '07:09', departureTime: null },
        { id: '2025-05-01', date: '2025-05-01', arrivalTime: '07:14', departureTime: null },
        { id: '2025-04-30', date: '2025-04-30', arrivalTime: '07:14', departureTime: null },
        { id: '2025-04-29', date: '2025-04-29', arrivalTime: '06:55', departureTime: null },
        { id: '2025-04-28', date: '2025-04-28', arrivalTime: '07:13', departureTime: null },
        { id: '2025-04-25', date: '2025-04-25', arrivalTime: '07:16', departureTime: null },
        { id: '2025-04-24', date: '2025-04-24', arrivalTime: '07:10', departureTime: null },
        { id: '2025-04-23', date: '2025-04-23', arrivalTime: '06:55', departureTime: null },
        { id: '2025-04-22', date: '2025-04-22', arrivalTime: '07:15', departureTime: null },
        { id: '2025-04-21', date: '2025-04-21', arrivalTime: '07:35', departureTime: null },
        { id: '2025-04-11', date: '2025-04-11', arrivalTime: '07:06', departureTime: null },
        { id: '2025-04-10', date: '2025-04-10', arrivalTime: '07:11', departureTime: null },
        { id: '2025-04-09', date: '2025-04-09', arrivalTime: '07:11', departureTime: null },
        { id: '2025-04-08', date: '2025-04-08', arrivalTime: '07:12', departureTime: null },
        { id: '2025-04-04', date: '2025-04-04', arrivalTime: '07:25', departureTime: null },
        { id: '2025-04-03', date: '2025-04-03', arrivalTime: '07:17', departureTime: null },
        { id: '2025-04-02', date: '2025-04-02', arrivalTime: '07:40', departureTime: null },
      ].sort((a, b) => b.date.localeCompare(a.date));
      
      const PALETTE = ["#778899", "#D2B48C", "#BC8F8F", "#829494", "#C7A27E", "#9E7E76", "#6e8eac", "#e0c1b6", "#a9c0a6", "#c9b19e", "#456882", "#d2c1b6"];
      
      const ACCENT_COLORS = [
          '#007AFF', // Blue
          '#34C759', // Green
          '#FF9500', // Orange
          '#FF3B30', // Red
          '#AF52DE', // Purple
          '#5856D6', // Indigo
          '#FF2D55', // Pink
          '#0A84FF', // Teal
      ];
      
      const THAI_HOLIDAYS_2025 = [
        { date: '2025-01-01', name: 'New Year\'s Day' },
        { date: '2025-02-12', name: 'Makha Bucha Day' },
        { date: '2025-04-06', name: 'Chakri Memorial Day' },
        { date: '2025-04-07', name: 'Substitution for Chakri Memorial Day' },
        { date: '2025-04-13', name: 'Songkran Festival' },
        { date: '2025-04-14', name: 'Songkran Festival' },
        { date: '2025-04-15', name: 'Songkran Festival' },
        { date: '2025-04-16', name: 'Extra Songkran Holiday' },
        { date: '2025-05-01', name: 'National Labour Day' },
        { date: '2025-05-04', name: 'Coronation Day' },
        { date: '2025-05-05', name: 'Substitution for Coronation Day' },
        { date: '2025-05-09', name: 'Royal Ploughing Ceremony Day' },
        { date: '2025-05-11', name: 'Visakha Bucha Day' },
        { date: '2025-05-12', name: 'Substitution for Visakha Bucha Day' },
        { date: '2025-06-03', name: 'Queen Suthida\'s Birthday' },
        { date: '2025-07-10', name: 'Asalha Bucha Day' },
        { date: '2025-07-11', name: 'Khao Phansa Day' },
        { date: '2025-07-28', name: 'King Vajiralongkorn\'s Birthday' },
        { date: '2025-08-12', name: 'The Queen Mother\'s Birthday / Mother\'s Day' },
        { date: '2025-10-13', name: 'King Bhumibol Memorial Day' },
        { date: '2025-10-23', name: 'King Chulalongkorn Day' },
        { date: '2025-12-05', name: 'Father\'s Day / National Day' },
        { date: '2025-12-10', name: 'Constitution Day' },
        { date: '2025-12-31', name: 'New Year\'s Eve' },
        { date: '2025-10-11', name: 'Semester 1 Break' },
        { date: '2025-10-12', name: 'Semester 1 Break' },
        { date: '2025-12-06', name: 'Mid-term Break' },
        { date: '2025-12-07', name: 'Mid-term Break' },
        { date: '2025-12-08', name: 'Mid-term Break' },
        { date: '2025-12-09', name: 'Mid-term Break' },
        { date: '2025-12-11', name: 'Mid-term Break' },
        { date: '2025-12-12', name: 'Mid-term Break' },
        { date: '2025-12-13', name: 'Mid-term Break' },
        { date: '2025-12-14', name: 'Mid-term Break' },
        { date: '2025-12-15', name: 'Mid-term Break' },
        { date: '2025-12-16', name: 'Mid-term Break' },
        { date: '2025-12-17', name: 'Mid-term Break' },
        { date: '2025-12-18', name: 'Mid-term Break' },
        { date: '2025-12-19', name: 'Mid-term Break' },
        { date: '2025-12-20', name: 'Mid-term Break' },
        { date: '2025-12-21', name: 'Mid-term Break' },
        { date: '2025-12-22', name: 'Mid-term Break' },
        { date: '2025-12-23', name: 'Mid-term Break' },
        { date: '2025-12-24', name: 'Mid-term Break' },
        { date: '2025-12-25', name: 'Mid-term Break' },
        { date: '2025-12-26', name: 'Mid-term Break' },
        { date: '2025-12-27', name: 'Mid-term Break' },
        { date: '2025-12-28', name: 'Mid-term Break' },
        { date: '2025-12-29', name: 'Mid-term Break' },
        { date: '2025-12-30', name: 'Mid-term Break' },
        { date: '2026-01-01', name: 'New Year\'s Day / Mid-term Break' },
        { date: '2026-01-02', name: 'Mid-term Break' },
        { date: '2026-01-03', name: 'Mid-term Break' },
        { date: '2026-01-04', name: 'Mid-term Break' },
      ].sort((a, b) => a.date.localeCompare(b.date));
      
      // =================================================================================
      // UTILITY FUNCTIONS
      // =================================================================================
      
      function combineDateTime(dateStr, timeStr) {
        return parse(`${dateStr}T${timeStr}`, "yyyy-MM-dd'T'HH:mm", new Date());
      }
      
      function getScheduleForDate(date, schedules) {
          const referenceDate = startOfDay(date);
          const dateBasedSchedule = schedules.find(s => {
              if (!s.startDate || !s.endDate) return false;
              try {
                  const startDate = parseISO(s.startDate);
                  const endDate = parseISO(s.endDate);
                  endDate.setHours(23, 59, 59, 999);
                  return isWithinInterval(referenceDate, { start: startDate, end: endDate });
              } catch (e) {
                  console.error("Invalid date format in schedule:", s);
                  return false;
              }
          });
          return dateBasedSchedule || null;
      }
      
      function getStatus(dateStr, arrivalTimeStr, schedules, gracePeriod, holidays, statusTag) {
        try {
          const date = parseISO(dateStr);
          const schedule = getScheduleForDate(date, schedules);
      
          if (!schedule) return 'NO_SCHEDULE';
          
          if (holidays.some(h => h.date === dateStr)) return 'HOLIDAY';
      
          if (statusTag === 'Absent') return 'ABSENT';
          if (statusTag === 'Holiday') return 'HOLIDAY';
      
          const dayOfWeek = getDay(date);
      
          const rule = schedule.rules.find(r => r.dayOfWeek === dayOfWeek);
          
          const firstPhysicalClass = rule?.classes?.filter(c => !c.isOnline).slice().sort((a,b) => a.startTime.localeCompare(b.startTime))[0];
      
          if (!rule || !firstPhysicalClass) {
            return 'DAY_OFF';
          }
      
          const requiredArrivalTimeStr = firstPhysicalClass.startTime;
      
          if (!arrivalTimeStr) {
            const today = startOfDay(new Date());
            return startOfDay(date) < today ? 'ABSENT' : 'NO_ENTRY';
          }
      
          const arrivalTime = combineDateTime(dateStr, arrivalTimeStr);
          const requiredTime = combineDateTime(dateStr, requiredArrivalTimeStr);
          const graceTime = addMinutes(requiredTime, gracePeriod);
      
          if (isAfter(arrivalTime, graceTime)) {
            return 'LATE';
          }
      
          if (isBefore(arrivalTime, requiredTime) || isEqual(arrivalTime, requiredTime)) {
            return 'EARLY';
          }
      
          return 'ON_TIME';
        } catch (e) {
          console.error("Error calculating status for", dateStr, e);
          return 'NO_SCHEDULE';
        }
      }
      
      const STATUS_MAP = {
          ON_TIME: { text: 'On Time', color: 'text-success-dark dark:text-green-300', bg: 'bg-green-500/10' },
          LATE: { text: 'Late', color: 'text-warning-dark dark:text-amber-400', bg: 'bg-amber-500/10' },
          EARLY: { text: 'Early', color: 'text-primary dark:text-blue-300', bg: 'bg-blue-500/10' },
          DAY_OFF: { text: 'Day Off', color: 'text-zinc-600 dark:text-zinc-400', bg: 'bg-zinc-200 dark:bg-zinc-700' },
          ABSENT: { text: 'Absent', color: 'text-danger-dark dark:text-red-400', bg: 'bg-red-500/10' },
          HOLIDAY: { text: 'Holiday', color: 'text-holiday-dark dark:text-indigo-300', bg: 'bg-indigo-500/10' },
          NO_ENTRY: { text: 'No Entry', color: 'text-zinc-600 dark:text-zinc-400', bg: 'bg-zinc-200 dark:bg-zinc-700' },
          NO_SCHEDULE: { text: 'No Schedule', color: 'text-zinc-600 dark:text-zinc-400', bg: 'bg-zinc-200 dark:bg-zinc-700' },
      };
      
      const CHART_COLORS = {
          onTime: '#34c759',
          late: '#ff9f0a',
          absent: '#ff453a',
          early: '#0a84ff',
          holiday: '#5e5ce6',
          actual: 'var(--color-primary)',
          target: '#8e8e93',
          dayOff: '#d1d1d6'
      };
      
      function getHeatmapColor(status) {
        switch (status) {
          case 'ON_TIME': return 'bg-green-400 dark:bg-green-600';
          case 'EARLY': return 'bg-blue-400 dark:bg-blue-600';
          case 'LATE': return 'bg-yellow-400 dark:bg-yellow-500';
          case 'ABSENT': return 'bg-red-400 dark:bg-red-500';
          case 'DAY_OFF': return 'bg-zinc-200 dark:bg-zinc-700';
          case 'HOLIDAY': return 'bg-indigo-400 dark:bg-indigo-600';
          default: return 'bg-zinc-100 dark:bg-zinc-800';
        }
      }
      
      function formatTime(timeStr) {
          if (!timeStr) return '--:--';
          try {
              const date = parse(timeStr, 'HH:mm', new Date());
              return format(date, 'p');
          } catch {
              return '--:--'
          }
      }
      
      function timeToMinutes(timeStr) {
          const [hours, minutes] = timeStr.split(':').map(Number);
          return hours * 60 + minutes;
      }
      
      function minutesToTime(minutes) {
          if (isNaN(minutes) || minutes === null) return '--:--';
          const date = new Date(1970, 0, 1, 0, Math.round(minutes));
          return format(date, 'p');
      }
      
      const timeAxisFormatter = (value) => {
          const hours = Math.floor(value / 60);
          const minutes = value % 60;
          return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
      };
      
      function calculateLateness(log, schedules, gracePeriod = 0) {
        if (!log.arrivalTime) return 0;
        
        try {
          const date = parseISO(log.date);
          const schedule = getScheduleForDate(date, schedules);
          if (!schedule) return 0;
      
          const dayOfWeek = getDay(date);
          const rule = schedule.rules.find(r => r.dayOfWeek === dayOfWeek);
          
          const firstPhysicalClass = rule?.classes?.filter(c => !c.isOnline).slice().sort((a,b) => a.startTime.localeCompare(b.startTime))[0];
          if (!rule || !firstPhysicalClass) return 0;
          
          const requiredArrivalTime = firstPhysicalClass.startTime;
      
          const arrivalTime = combineDateTime(log.date, log.arrivalTime);
          const requiredTimeWithGrace = addMinutes(combineDateTime(log.date, requiredArrivalTime), gracePeriod);
          
          const diff = differenceInMinutes(arrivalTime, requiredTimeWithGrace);
          
          return diff > 0 ? diff : 0;
        } catch (e) {
          console.error("Error calculating lateness for", log, e);
          return 0;
        }
      }
      
      function calculateOnTimeStreak(logsWithStatus, schedules, holidays) {
          let streak = 0;
          const logsByDate = logsWithStatus.reduce((acc, log) => {
              acc[log.date] = log;
              return acc;
          }, {});
          
          let currentDate = startOfDay(new Date());
      
          for (let i = 0; i < 365; i++) {
              const dateStr = format(currentDate, 'yyyy-MM-dd');
              
              const isHoliday = holidays.some(h => h.date === dateStr);
              const schedule = getScheduleForDate(currentDate, schedules);
              const dayOfWeek = getDay(currentDate);
              const rule = schedule?.rules.find(r => r.dayOfWeek === dayOfWeek);
              const firstPhysicalClass = rule?.classes?.filter(c => !c.isOnline).slice().sort((a,b) => a.startTime.localeCompare(b.startTime))[0];
              const isDayOff = !schedule || !rule || !firstPhysicalClass;
      
              if (isHoliday || isDayOff) {
                  currentDate = subDays(currentDate, 1);
                  continue;
              }
      
              const log = logsByDate[dateStr];
              
              if (!log) {
                  if (isBefore(currentDate, startOfDay(new Date()))) {
                      return streak;
                  } else {
                      return streak; 
                  }
              }
              
              if (log.status === 'ON_TIME' || log.status === 'EARLY') {
                  streak++;
              } else if (log.status === 'LATE' || log.status === 'ABSENT') {
                  return streak;
              }
              
              currentDate = subDays(currentDate, 1);
          }
          
          return streak;
      }
      
      function getGreeting() {
        const hour = new Date().getHours();
        if (hour < 12) return 'Good Morning';
        if (hour < 18) return 'Good Afternoon';
        return 'Good Evening';
      }
      
      const adjustColor = (hex, amount) => {
          let color = parseInt(hex.slice(1), 16);
          let r = Math.min(255, Math.max(0, (color >> 16) + amount));
          let g = Math.min(255, Math.max(0, ((color >> 8) & 0x00FF) + amount));
          let b = Math.min(255, Math.max(0, (color & 0x0000FF) + amount));
          return `#${(b | (g << 8) | (r << 16)).toString(16).padStart(6, '0')}`;
      };
      
      function applyTheme(theme, accentColor) {
          const root = document.documentElement;
          if (theme === 'system') {
              const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
              root.classList.toggle('dark', prefersDark);
          } else {
              root.classList.toggle('dark', theme === 'dark');
          }
      
          if (!/^#[0-9a-f]{6}$/i.test(accentColor)) return;
          const r = parseInt(accentColor.slice(1, 3), 16);
          const g = parseInt(accentColor.slice(3, 5), 16);
          const b = parseInt(accentColor.slice(5, 7), 16);
      
          root.style.setProperty('--color-primary', accentColor);
          root.style.setProperty('--color-primary-hover', adjustColor(accentColor, -20));
          root.style.setProperty('--color-primary-rgb', `${r}, ${g}, ${b}`);
      }
      
      function getContrastingTextColor(hex) {
          if (!hex) return '#ffffff';
          try {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#ffffff';
          } catch (e) {
            return '#ffffff';
          }
      }
      
      const DAYS_OF_WEEK_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const ENG_TO_THAI_DAY_MAP = { 'Monday': 'à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œ', 'Tuesday': 'à¸§à¸±à¸™à¸­à¸±à¸‡à¸„à¸²à¸£', 'Wednesday': 'à¸§à¸±à¸™à¸žà¸¸à¸˜', 'Thursday': 'à¸§à¸±à¸™à¸žà¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ', 'Friday': 'à¸§à¸±à¸™à¸¨à¸¸à¸à¸£à¹Œ', 'Saturday': 'à¸§à¸±à¸™à¹€à¸ªà¸²à¸£à¹Œ', 'Sunday': 'à¸§à¸±à¸™à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ' };
      const THAI_REGEX = /[\u0E00-\u0E7F]/;
      
      const DAY_KEYWORD_MAP = {
          'monday': 'Monday', 'mon': 'Monday', 'à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œ': 'Monday', 'à¸ˆà¸±à¸™à¸—à¸£à¹Œ': 'Monday',
          'tuesday': 'Tuesday', 'tue': 'Tuesday', 'tues': 'Tuesday', 'à¸§à¸±à¸™à¸­à¸±à¸‡à¸„à¸²à¸£': 'Tuesday', 'à¸­à¸±à¸‡à¸„à¸²à¸£': 'Tuesday',
          'wednesday': 'Wednesday', 'wed': 'Wednesday', 'à¸§à¸±à¸™à¸žà¸¸à¸˜': 'Wednesday', 'à¸žà¸¸à¸˜': 'Wednesday',
          'thursday': 'Thursday', 'thu': 'Thursday', 'thurs': 'Thursday', 'à¸§à¸±à¸™à¸žà¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ': 'Thursday', 'à¸žà¸¤à¸«à¸±à¸ª': 'Thursday',
          'friday': 'Friday', 'fri': 'Friday', 'à¸§à¸±à¸™à¸¨à¸¸à¸à¸£à¹Œ': 'Friday', 'à¸¨à¸¸à¸à¸£à¹Œ': 'Friday',
          'saturday': 'Saturday', 'sat': 'Saturday', 'à¸§à¸±à¸™à¹€à¸ªà¸²à¸£à¹Œ': 'Saturday', 'à¹€à¸ªà¸²à¸£à¹Œ': 'Saturday',
          'sunday': 'Sunday', 'sun': 'Sunday', 'à¸§à¸±à¸™à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ': 'Sunday', 'à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ': 'Sunday',
          'today': 'today', 'à¸§à¸±à¸™à¸™à¸µà¹‰': 'today',
          'tomorrow': 'tomorrow', 'à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰': 'tomorrow',
          'yesterday': 'yesterday', 'à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™': 'yesterday',
      };
      
      const TIME_CONTEXT_MAP = {
          'morning': { start: '00:00', end: '12:00', eng: 'morning', thai: 'à¸•à¸­à¸™à¹€à¸Šà¹‰à¸²' },
          'à¸•à¸­à¸™à¹€à¸Šà¹‰à¸²': { start: '00:00', end: '12:00', eng: 'morning', thai: 'à¸•à¸­à¸™à¹€à¸Šà¹‰à¸²' },
          'afternoon': { start: '12:00', end: '17:00', eng: 'afternoon', thai: 'à¸•à¸­à¸™à¸šà¹ˆà¸²à¸¢' },
          'à¸•à¸­à¸™à¸šà¹ˆà¸²à¸¢': { start: '12:00', end: '17:00', eng: 'afternoon', thai: 'à¸•à¸­à¸™à¸šà¹ˆà¸²à¸¢' },
          'evening': { start: '17:00', end: '24:00', eng: 'evening', thai: 'à¸•à¸­à¸™à¹€à¸¢à¹‡à¸™' },
          'à¸•à¸­à¸™à¹€à¸¢à¹‡à¸™': { start: '17:00', end: '24:00', eng: 'evening', thai: 'à¸•à¸­à¸™à¹€à¸¢à¹‡à¸™' },
      };
      
      const processQuestion = (query, schedules, subjectMeta) => {
          const lowerQuery = query.toLowerCase().trim().replace(/[?.,]/g, '');
          const isThaiQuery = THAI_REGEX.test(lowerQuery);
          const now = new Date();
          const todayName = DAYS_OF_WEEK_NAMES[now.getDay()];
          const nowTime = now.toTimeString().substring(0, 5);
      
          const getResponse = (eng, thai) => isThaiQuery ? thai : eng;
      
          const buildSubjectKeywordMap = () => {
              const map = {};
              for (const subject of Object.keys(subjectMeta)) {
                  map[subject.toLowerCase()] = subject;
                  if (subject.includes('(')) {
                       map[subject.split('(')[0].trim().toLowerCase()] = subject;
                  }
              }
              return map;
          };
          const SUBJECT_KEYWORD_MAP = buildSubjectKeywordMap();
      
          const extractTimeContext = () => {
              for (const [keyword, context] of Object.entries(TIME_CONTEXT_MAP)) {
                  if (lowerQuery.includes(keyword)) return context;
              }
              return null;
          };
      
          const extractDay = () => {
              for (const [keyword, day] of Object.entries(DAY_KEYWORD_MAP)) {
                  if (lowerQuery.includes(keyword)) {
                      if (day === 'today') return todayName;
                      if (day === 'tomorrow') return DAYS_OF_WEEK_NAMES[(now.getDay() + 1) % 7];
                      if (day === 'yesterday') return DAYS_OF_WEEK_NAMES[(now.getDay() + 6) % 7];
                      return day;
                  }
              }
              return null;
          };
      
          const extractSubject = () => {
              const sortedKeywords = Object.keys(SUBJECT_KEYWORD_MAP).sort((a,b) => b.length - a.length);
              for (const keyword of sortedKeywords) {
                  if (lowerQuery.includes(keyword)) return SUBJECT_KEYWORD_MAP[keyword];
              }
              return null;
          };
      
          const taskKeywords = ['homework', 'task', 'assignment', 'due', 'à¸à¸²à¸£à¸šà¹‰à¸²à¸™', 'à¸‡à¸²à¸™', 'à¸•à¹‰à¸­à¸‡à¸—à¸³', 'à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡'];
          if (taskKeywords.some(k => lowerQuery.includes(k))) {
              const targetDayName = extractDay();
              const targetSubject = extractSubject();
              const isUnfinishedQuery = lowerQuery.includes('unfinished') || lowerQuery.includes('pending') || lowerQuery.includes('à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸ªà¸£à¹‡à¸ˆ');
              let tasksFound = [];
      
              const daysToSearch = targetDayName ? [targetDayName] : DAYS_OF_WEEK_NAMES.slice(1, 6);
      
              schedules.forEach(schedule => {
                  schedule.rules.forEach(rule => {
                      const dayName = DAYS_OF_WEEK_NAMES[rule.dayOfWeek];
                      if (!daysToSearch.includes(dayName)) return;
      
                      rule.classes.forEach(cls => {
                          if (targetSubject && cls.subject !== targetSubject) return;
                          if (!cls.tasks || cls.tasks.length === 0) return;
      
                          cls.tasks.forEach(task => {
                              if (isUnfinishedQuery && task.completed) return;
                              tasksFound.push({ day: dayName, subject: cls.subject, text: task.text, completed: task.completed });
                          });
                      });
                  });
              });
      
              if (tasksFound.length === 0) {
                  let responseEng = isUnfinishedQuery ? "You have no pending tasks" : "No tasks found";
                  let responseThai = isUnfinishedQuery ? "à¹„à¸¡à¹ˆà¸¡à¸µà¸‡à¸²à¸™à¸„à¹‰à¸²à¸‡à¹€à¸¥à¸¢" : "à¹„à¸¡à¹ˆà¸žà¸šà¸‡à¸²à¸™";
                  if (targetSubject) {
                      responseEng += ` for ${targetSubject}`;
                      responseThai += `à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸´à¸Šà¸² ${targetSubject}`;
                  }
                  if (targetDayName) {
                      responseEng += ` on ${targetDayName}`;
                      responseThai += `à¹ƒà¸™${ENG_TO_THAI_DAY_MAP[targetDayName] || targetDayName}`;
                  }
                  return getResponse(responseEng + ".", responseThai + "à¸™à¸°");
              }
      
              let response = getResponse("Here are your tasks:", "à¸™à¸µà¹ˆà¸„à¸·à¸­à¸£à¸²à¸¢à¸à¸²à¸£à¸‡à¸²à¸™à¸‚à¸­à¸‡à¹€à¸˜à¸­:");
              const groupedTasks = tasksFound.reduce((acc, task) => {
                  const key = `${task.day} - ${task.subject}`;
                  if (!acc[key]) {
                      acc[key] = { day: task.day, subject: task.subject, tasks: [] };
                  }
                  acc[key].tasks.push(task);
                  return acc;
              }, {});
      
              for (const groupKey in groupedTasks) {
                  const group = groupedTasks[groupKey];
                  const dayDisplay = getResponse(group.day, ENG_TO_THAI_DAY_MAP[group.day]);
                  const icon = subjectMeta[group.subject]?.icon || 'ðŸ“š';
                  const iconHtml = `${icon} `;
                  response += `\n\n**${iconHtml}${group.subject} (${dayDisplay})**`;
                  group.tasks.forEach((task) => {
                      const status = task.completed ? getResponse(' (Done)', ' (à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§)') : '';
                      response += `\n- ${task.text}${isUnfinishedQuery ? '' : status}`;
                  });
              }
              return response;
          }
      
          const targetDayName = extractDay();
          const targetSubject = extractSubject();
          const timeContext = extractTimeContext();
          const dayToQueryName = targetDayName || todayName;
          const dayToQueryIndex = DAYS_OF_WEEK_NAMES.indexOf(dayToQueryName);
          const dayDisplay = isThaiQuery ? ENG_TO_THAI_DAY_MAP[dayToQueryName] : dayToQueryName;
      
          const referenceDate = new Date();
          if (targetDayName) {
              const todayIndex = now.getDay();
              const diff = dayToQueryIndex - todayIndex;
              referenceDate.setDate(now.getDate() + diff);
          }
          const scheduleForDay = getScheduleForDate(referenceDate, schedules);
          
          let dayClasses = scheduleForDay?.rules.find(r => r.dayOfWeek === dayToQueryIndex)?.classes.slice().sort((a, b) => a.startTime.localeCompare(b.startTime)) || [];
      
          if (timeContext) {
              dayClasses = dayClasses.filter(c => c.startTime >= timeContext.start && c.startTime < timeContext.end);
              if (dayClasses.length === 0) {
                  return getResponse(`You have no classes in the ${timeContext.eng} on ${dayToQueryName}.`, `à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™${timeContext.thai}à¹ƒà¸™${dayDisplay}`);
              }
          }
      
          if (lowerQuery.includes('full schedule') || lowerQuery.includes('weekly schedule') || lowerQuery.includes('all week') || lowerQuery.includes('à¸—à¸±à¹‰à¸‡à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ') || lowerQuery.includes('à¸—à¸±à¹‰à¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ')) {
              let fullScheduleStr = getResponse("Here's your weekly schedule:", "à¸™à¸µà¹ˆà¸„à¸·à¸­à¸•à¸²à¸£à¸²à¸‡à¸ªà¸­à¸™à¸—à¸±à¹‰à¸‡à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸‚à¸­à¸‡à¹€à¸˜à¸­:");
              const scheduleToUse = getScheduleForDate(new Date(), schedules);
              if (!scheduleToUse) return "I can't find a schedule for this week.";
      
              for (const dayName of DAYS_OF_WEEK_NAMES.slice(1, 6)) {
                  const dayIndex = DAYS_OF_WEEK_NAMES.indexOf(dayName);
                  const classes = scheduleToUse.rules.find(r => r.dayOfWeek === dayIndex)?.classes || [];
                  fullScheduleStr += `\n\n**${getResponse(dayName, ENG_TO_THAI_DAY_MAP[dayName])}**`;
                  if (classes.length === 0) {
                      fullScheduleStr += getResponse(`\n- No classes!`, `\n- à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™!`);
                  } else {
                      classes.forEach(c => {
                          const icon = subjectMeta[c.subject]?.icon || 'ðŸ“š';
                          fullScheduleStr += `\n- ${icon} ${c.subject} (${c.startTime} - ${c.endTime})${c.isOnline ? ' (Flipped)' : ''}`;
                      });
                  }
              }
              return fullScheduleStr;
          }
      
          if (lowerQuery.includes('now') || lowerQuery.includes('à¸•à¸­à¸™à¸™à¸µà¹‰')) {
              if(dayToQueryName !== todayName) return getResponse(`I can only tell you what's happening 'now' for today. For ${dayToQueryName}, please ask about a specific time.`, `à¸šà¸­à¸à¹„à¸”à¹‰à¹à¸„à¹ˆà¸§à¹ˆà¸² 'à¸•à¸­à¸™à¸™à¸µà¹‰' à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸™à¸° à¸–à¹‰à¸²à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰à¸§à¸±à¸™à¸­à¸·à¹ˆà¸™ à¹ƒà¸«à¹‰à¸–à¸²à¸¡à¹€à¸§à¸¥à¸²à¹€à¸ˆà¸²à¸°à¸ˆà¸‡à¸¡à¸²à¹€à¸¥à¸¢`);
              const currentClass = dayClasses.find(c => nowTime >= c.startTime && nowTime < c.endTime);
              if(currentClass) return getResponse(`You are currently in **${currentClass.subject}**, which ends at ${currentClass.endTime}.`, `à¸•à¸­à¸™à¸™à¸µà¹‰à¸à¸³à¸¥à¸±à¸‡à¹€à¸£à¸µà¸¢à¸™à¸§à¸´à¸Šà¸² **${currentClass.subject}** à¸­à¸¢à¸¹à¹ˆ à¹€à¸¥à¸´à¸à¸•à¸­à¸™ ${current.endTime}`);
              const nextClass = dayClasses.find(c => c.startTime > nowTime);
              if(nextClass) return getResponse(`You're on a break. Your next class is **${nextClass.subject}** at ${nextClass.startTime}.`, `à¸•à¸­à¸™à¸™à¸µà¹‰à¸žà¸±à¸à¸­à¸¢à¸¹à¹ˆ à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›à¹€à¸£à¸µà¸¢à¸™ **${nextClass.subject}** à¸•à¸­à¸™ ${nextClass.startTime}`);
              return getResponse(`You're done for today! No more classes scheduled right now.`, `à¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸£à¸µà¸¢à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§! à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸²à¸šà¹€à¸£à¸µà¸¢à¸™à¹à¸¥à¹‰à¸§à¸ˆà¹‰à¸²`);
          }
      
          if ((lowerQuery.includes('next') || lowerQuery.includes('à¸–à¸±à¸”à¹„à¸›') || lowerQuery.includes('à¸•à¹ˆà¸­à¹„à¸›')) && !targetSubject) {
              if(dayToQueryName !== todayName) return getResponse(`I can only tell you the 'next' class for today.`, `à¸šà¸­à¸ 'à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›' à¹„à¸”à¹‰à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸™à¸°`);
              const nextClass = dayClasses.find(c => c.startTime > nowTime);
              return nextClass ? getResponse(`Your next class is **${nextClass.subject}** at ${nextClass.startTime}.`, `à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›à¸„à¸·à¸­ **${nextClass.subject}** à¸•à¸­à¸™ ${nextClass.startTime}`) : getResponse(`You have no more classes scheduled for today.`, `à¸§à¸±à¸™à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¹à¸¥à¹‰à¸§`);
          }
      
          if (targetSubject) {
              const classesOnDay = dayClasses.filter(c => c.subject === targetSubject);
              if (classesOnDay.length > 0) {
                  const times = classesOnDay.map(c => `${c.startTime} - ${c.endTime}`).join(' and ');
                  return getResponse(`Yes, you have **${targetSubject}** on ${dayToQueryName} from ${times}.`, `à¹ƒà¸Šà¹ˆ à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ **${targetSubject}** à¹ƒà¸™${dayDisplay} à¸•à¸­à¸™ ${times}`);
              }
              return getResponse(`Nope, you do not have **${targetSubject}** on ${dayToQueryName}.`, `à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ **${targetSubject}** à¹ƒà¸™${dayDisplay}`);
          }
      
          if (targetDayName) {
              if (dayClasses.length === 0) return getResponse(`You have no classes scheduled for ${targetDayName}. Enjoy your free day! ðŸŽ‰`, `${dayDisplay}à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¸™à¸° à¸žà¸±à¸à¸œà¹ˆà¸­à¸™à¹„à¸”à¹‰à¹€à¸¥à¸¢! ðŸŽ‰`);
              const classList = dayClasses.map(c => {
                  const icon = subjectMeta[c.subject]?.icon || 'ðŸ“š';
                  return `\n- ${icon} **${c.subject}** (${c.startTime} - ${c.endTime})`
              }).join('');
              return getResponse(`On ${targetDayName}, your schedule is:${classList}`, `à¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™${dayDisplay}à¸„à¸·à¸­:${classList}`);
          }
      
          return getResponse(
              "Sorry, I couldn't understand that. You can ask for a day's schedule (e.g., 'What's on Monday?'), ask about a class (e.g., 'Do I have Math today?'), or ask 'what's next?'.",
              "à¸‚à¸­à¹‚à¸—à¸©à¸™à¸° à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸—à¸µà¹ˆà¸–à¸²à¸¡à¹€à¸¥à¸¢ à¸¥à¸­à¸‡à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™à¸”à¸¹à¸ªà¸´ à¹€à¸Šà¹ˆà¸™ 'à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œà¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£?', 'à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¸„à¸“à¸´à¸•à¹„à¸«à¸¡?', à¸«à¸£à¸·à¸­ 'à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£?'"
          );
      };
      
      // =================================================================================
      // HOOKS
      // =================================================================================
      
      function useLocalStorage(key, initialValue) {
        const [storedValue, setStoredValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });
      
        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
          } catch (error) {
            console.error(error);
          }
        };
      
        useEffect(() => {
          const handleStorageChange = (e) => {
            if (e.key === key && e.newValue) {
              setStoredValue(JSON.parse(e.newValue));
            }
          };
          window.addEventListener('storage', handleStorageChange);
          return () => {
            window.removeEventListener('storage', handleStorageChange);
          };
        }, [key]);
      
        return [storedValue, setValue];
      }
      
      function useMediaQuery(query) {
        const getMatches = (query) => {
          if (typeof window !== 'undefined') {
            return window.matchMedia(query).matches;
          }
          return false;
        };
      
        const [matches, setMatches] = useState(getMatches(query));
      
        function handleChange() {
          setMatches(getMatches(query));
        }
      
        useEffect(() => {
          const matchMedia = window.matchMedia(query);
          handleChange();
          matchMedia.addEventListener('change', handleChange);
          return () => {
            matchMedia.removeEventListener('change', handleChange);
          };
        }, [query]);
      
        return matches;
      }
      
      function useAppData() {
        const [settings, setSettings] = useLocalStorage('classdy-settings', DEFAULT_SETTINGS);
        const [schedules, setSchedules] = useLocalStorage('classdy-schedules', INITIAL_SCHEDULES);
        const [logs, setLogs] = useLocalStorage('classdy-logs', INITIAL_LOGS);
        const [subjectMeta, setSubjectMeta] = useLocalStorage('classdy-subject-meta', INITIAL_SUBJECT_META);
        
        const holidays = useMemo(() => THAI_HOLIDAYS_2025, []);
      
        const activeSchedule = useMemo(() => {
          let referenceDate;
          if (logs && logs.length > 0) {
            try {
              referenceDate = parseISO(logs[0].date);
            } catch {
              referenceDate = new Date();
            }
          } else {
            referenceDate = new Date();
          }
          
          const scheduleForDate = getScheduleForDate(referenceDate, schedules);
          return scheduleForDate || schedules[0] || null;
        }, [schedules, logs]);
      
        const updateSettings = useCallback((newSettings) => {
          setSettings(prev => ({ ...prev, ...newSettings }));
        }, [setSettings]);
      
        const saveSchedule = useCallback((scheduleToSave) => {
          setSchedules(prev => {
            const index = prev.findIndex(s => s.id === scheduleToSave.id);
            if (index > -1) {
              const newSchedules = [...prev];
              newSchedules[index] = scheduleToSave;
              return newSchedules;
            }
            return [...prev, scheduleToSave];
          });
        }, [setSchedules]);
        
        const replaceAllSchedules = useCallback((newSchedules) => {
            setSchedules(newSchedules);
        }, [setSchedules]);
      
        const deleteSchedule = useCallback((scheduleId) => {
          setSchedules(prev => prev.filter(s => s.id !== scheduleId));
        }, [setSchedules]);
      
        const addOrUpdateLog = useCallback((logToAdd) => {
          const logId = logToAdd.date;
          const newLog = { ...logToAdd, id: logId };
          
          setLogs(prev => {
            const index = prev.findIndex(l => l.id === logId);
            if (index > -1) {
              const newLogs = [...prev];
              newLogs[index] = newLog;
              return newLogs.sort((a, b) => b.date.localeCompare(a.date));
            }
            return [...prev, newLog].sort((a, b) => b.date.localeCompare(a.date));
          });
        }, [setLogs]);
        
        const replaceAllLogs = useCallback((newLogs) => {
            setLogs(newLogs.sort((a, b) => b.date.localeCompare(a.date)));
        }, [setLogs]);
      
        const deleteLog = useCallback((logId) => {
          setLogs(prev => prev.filter(l => l.id !== logId));
        }, [setLogs]);
      
        const replaceAllSubjectMeta = useCallback((newMeta) => {
          setSubjectMeta(newMeta);
        }, [setSubjectMeta]);
      
        const updateClassTasks = useCallback((scheduleId, dayOfWeek, classId, newTasks) => {
            setSchedules(prevSchedules => {
                return prevSchedules.map(schedule => {
                    if (schedule.id !== scheduleId) return schedule;
      
                    const newRules = schedule.rules.map(rule => {
                        if (rule.dayOfWeek !== dayOfWeek) return rule;
      
                        const newClasses = rule.classes.map(c => {
                            if (c.id !== classId) return c;
                            return { ...c, tasks: newTasks };
                        });
                        return { ...rule, classes: newClasses };
                    });
                    return { ...schedule, rules: newRules };
                });
            });
        }, [setSchedules]);
        
        return {
          settings,
          schedules,
          activeSchedule,
          logs,
          holidays,
          subjectMeta,
          updateSettings,
          saveSchedule,
          deleteSchedule,
          addOrUpdateLog,
          deleteLog,
          replaceAllLogs,
          replaceAllSchedules,
          replaceAllSubjectMeta,
          updateClassTasks,
        };
      }
      
      // =================================================================================
      // SHARED COMPONENTS
      // =================================================================================
      
      const Card = forwardRef(({ children, className = '', ...props }, ref) => {
        return (
          React.createElement('div', { ref: ref, className: `bg-white dark:bg-zinc-800/50 rounded-2xl shadow-soft ${className}`, ...props },
            children
          )
        );
      });
      Card.displayName = 'Card';
      
      const Modal = ({ isOpen, onClose, children, title, size = 'md' }) => {
        useEffect(() => {
          const handleKeyDown = (e) => {
            if (e.key === 'Escape') {
              onClose();
            }
          };
          if (isOpen) {
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', handleKeyDown);
          } else {
            document.body.style.overflow = '';
          }
          return () => {
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleKeyDown);
          };
        }, [isOpen, onClose]);
      
        if (!isOpen) return null;
      
        const sizeClasses = {
          sm: 'max-w-sm',
          md: 'max-w-md',
          lg: 'max-w-lg',
          xl: 'max-w-xl',
          '2xl': 'max-w-2xl',
        };
      
        return (
          React.createElement('div', { className: "fixed inset-0 bg-zinc-900/40 dark:bg-black/60 backdrop-blur-sm z-50 flex justify-center items-start sm:items-center p-4 animate-fade-in", onClick: onClose, role: "dialog", "aria-modal": "true", "aria-labelledby": "modal-title" },
            React.createElement('div', { className: `bg-white dark:bg-zinc-800 rounded-2xl shadow-soft-lg w-full ${sizeClasses[size]} max-h-[90vh] flex flex-col overflow-hidden`, onClick: (e) => e.stopPropagation() },
              React.createElement('div', { className: "flex justify-between items-center p-5 border-b border-zinc-200 dark:border-zinc-700 flex-shrink-0" },
                React.createElement('h2', { id: "modal-title", className: "text-lg font-semibold text-zinc-900 dark:text-zinc-100" }, title),
                React.createElement('button', { onClick: onClose, className: "text-zinc-500 dark:text-zinc-400 hover:text-zinc-800 dark:hover:text-zinc-200 rounded-full p-1 -m-1", "aria-label": "Close modal" },
                  React.createElement(X, { size: 24 })
                )
              ),
              React.createElement('div', { className: "flex-1 overflow-y-auto p-6" },
                children
              )
            )
          )
        );
      };
      
      const Section = ({ title, children, className = '' }) => (
          React.createElement('div', { className: `mb-8 ${className}` },
              React.createElement('h3', { className: "text-lg font-semibold text-zinc-800 dark:text-zinc-200 mb-4" }, title),
              React.createElement('div', { className: "space-y-4" }, children)
          )
      );
      
      const SubjectManager = ({ subjectMeta, onSave }) => {
          const [meta, setMeta] = useState(subjectMeta);
      
          const handleMetaChange = (subject, field, value) => {
              const newMeta = {
                  ...meta,
                  [subject]: {
                      ...(meta[subject] || { color: '#cccccc', icon: 'ðŸ“š' }),
                      [field]: value
                  }
              };
              setMeta(newMeta);
              onSave(newMeta);
          };
      
          const sortedSubjects = Object.keys(meta).sort();
      
          return (
              React.createElement(Section, { title: "Subject Appearance" },
                  React.createElement('p', { className: "text-sm text-zinc-600 dark:text-zinc-400 -mt-2 mb-4" }, "Customize the color and icon for each subject."),
                  React.createElement('div', { className: "space-y-2 max-h-96 overflow-y-auto pr-2 -mr-2" },
                      sortedSubjects.map(subject => (
                          React.createElement('div', { key: subject, className: "flex items-center gap-3 p-2 rounded-lg bg-zinc-100 dark:bg-zinc-800/50" },
                              React.createElement('input', {
                                  type: "color",
                                  value: meta[subject].color,
                                  onChange: (e) => handleMetaChange(subject, 'color', e.target.value),
                                  className: "w-8 h-8 p-0 border-none rounded-md cursor-pointer bg-transparent",
                                  "aria-label": `Color for ${subject}`
                              }),
                              React.createElement('input', {
                                  type: "text",
                                  value: meta[subject].icon || '',
                                  onChange: (e) => handleMetaChange(subject, 'icon', e.target.value),
                                  maxLength: 2,
                                  placeholder: "âœï¸",
                                  className: "w-10 h-8 text-center bg-zinc-200 dark:bg-zinc-700 rounded-md text-lg p-0",
                                  "aria-label": `Icon for ${subject}`
                              }),
                              React.createElement('span', { className: "flex-1 font-medium text-sm text-zinc-800 dark:text-zinc-200 truncate" }, subject)
                          )
                      ))
                  )
              )
          );
      };
      
      
      // =================================================================================
      // COMPONENTS
      // =================================================================================
      
      const AddLogModal = ({ isOpen, onClose, onSave, onDelete, log }) => {
        const [date, setDate] = useState('');
        const [arrivalTime, setArrivalTime] = useState('');
        const [departureTime, setDepartureTime] = useState('');
        const [statusTag, setStatusTag] = useState('None');
      
        useEffect(() => {
          if (log) {
            setDate(log.date);
            setArrivalTime(log.arrivalTime || '');
            setDepartureTime(log.departureTime || '');
            setStatusTag(log.statusTag || 'None');
          } else {
            const today = new Date();
            setDate(today.toISOString().split('T')[0]);
            const nowTime = today.toTimeString().slice(0, 5);
            setArrivalTime(nowTime);
            setDepartureTime('');
            setStatusTag('None');
          }
        }, [log, isOpen]);
      
        const handleSave = () => {
          if (!date) return;
          onSave({
            date,
            arrivalTime: statusTag !== 'None' ? null : arrivalTime || null,
            departureTime: statusTag !== 'None' ? null : departureTime || null,
            statusTag: statusTag === 'None' ? undefined : statusTag,
          });
          onClose();
        };
        
        const handleDelete = () => {
          if(log && window.confirm('Are you sure you want to delete this log?')) {
              onDelete(log.id);
              onClose();
          }
        }
      
        const inputClasses = "mt-1 block w-full rounded-lg border-zinc-300 dark:border-zinc-600 bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 shadow-sm focus:border-primary focus:ring-1 focus:ring-primary sm:text-sm";
        const labelClasses = "block text-sm font-medium text-zinc-700 dark:text-zinc-300";
      
        return (
          React.createElement(Modal, { isOpen: isOpen, onClose: onClose, title: log ? 'Edit Attendance Log' : 'Add Attendance Log' },
            React.createElement('div', { className: "space-y-6" },
              React.createElement('div', null,
                React.createElement('label', { htmlFor: "date", className: labelClasses }, "Date"),
                React.createElement('input', {
                  type: "date",
                  id: "date",
                  value: date,
                  onChange: (e) => setDate(e.target.value),
                  className: inputClasses,
                  style: { colorScheme: 'dark' }
                })
              ),
      
              React.createElement('div', null,
                 React.createElement('label', { htmlFor: "statusTag", className: labelClasses }, "Status Tag"),
                 React.createElement('select',
                   {
                     id: "statusTag",
                     value: statusTag,
                     onChange: (e) => setStatusTag(e.target.value),
                     className: inputClasses
                   },
                   React.createElement('option', { value: "None" }, "Normal"),
                   React.createElement('option', { value: "Absent" }, "Absent"),
                   React.createElement('option', { value: "Holiday" }, "Holiday")
                 )
               ),
      
              statusTag === 'None' && (
                React.createElement(React.Fragment, null,
                  React.createElement('div', null,
                    React.createElement('label', { htmlFor: "arrivalTime", className: labelClasses }, "Arrival Time"),
                    React.createElement('input', {
                      type: "time",
                      id: "arrivalTime",
                      value: arrivalTime,
                      onChange: (e) => setArrivalTime(e.target.value),
                      className: inputClasses,
                      style: { colorScheme: 'dark' }
                    })
                  ),
                  React.createElement('div', null,
                    React.createElement('label', { htmlFor: "departureTime", className: labelClasses }, "Departure Time (Optional)"),
                    React.createElement('input', {
                      type: "time",
                      id: "departureTime",
                      value: departureTime,
                      onChange: (e) => setDepartureTime(e.target.value),
                      className: inputClasses,
                      style: { colorScheme: 'dark' }
                    })
                  )
                )
              ),
              
              React.createElement('div', { className: "flex justify-between items-center pt-4" },
                React.createElement('div', null,
                  log && (
                      React.createElement('button',
                      {
                        onClick: handleDelete,
                        className: "inline-flex items-center justify-center rounded-lg bg-danger/10 px-4 py-2 text-sm font-medium text-danger-dark hover:bg-danger/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-danger"
                      },
                      React.createElement(Trash2, { size: 16, className: "mr-2"}),
                      "Delete"
                      )
                  )
                ),
                React.createElement('div', { className: "flex justify-end gap-3" },
                  React.createElement('button',
                      {
                          type: "button",
                          onClick: onClose,
                          className: "rounded-lg border-none bg-zinc-200 dark:bg-zinc-700 py-2 px-4 text-sm font-medium text-zinc-800 dark:text-zinc-200 shadow-sm hover:bg-zinc-300 dark:hover:bg-zinc-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary"
                      },
                      "Cancel"
                  ),
                  React.createElement('button',
                    {
                      onClick: handleSave,
                      className: "inline-flex justify-center rounded-lg border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-hover focus:outline-none focus-visible:ring-2 focus-visible:ring-primary"
                    },
                    "Save"
                  )
                )
              )
            )
          )
        );
      };
      
      const TaskModal = ({ isOpen, onClose, schedule, dayOfWeek, classId, onUpdateTasks, subjectMeta }) => {
          const [currentClass, setCurrentClass] = useState(null);
          const [tasks, setTasks] = useState([]);
          const [newTaskText, setNewTaskText] = useState('');
      
          useEffect(() => {
              if (isOpen) {
                  const rule = schedule.rules.find(r => r.dayOfWeek === dayOfWeek);
                  const classSession = rule?.classes.find(c => c.id === classId);
                  if (classSession) {
                      setCurrentClass(classSession);
                      setTasks(classSession.tasks);
                  }
              } else {
                  setCurrentClass(null);
                  setTasks([]);
                  setNewTaskText('');
              }
          }, [isOpen, schedule, dayOfWeek, classId]);
      
          const handleAddTask = () => {
              if (newTaskText.trim() === '') return;
              const newTask = {
                  id: `task-${Date.now()}`,
                  text: newTaskText.trim(),
                  completed: false,
              };
              const updatedTasks = [...tasks, newTask];
              setTasks(updatedTasks);
              onUpdateTasks(schedule.id, dayOfWeek, classId, updatedTasks);
              setNewTaskText('');
          };
      
          const handleToggleTask = (taskId) => {
              const updatedTasks = tasks.map(task =>
                  task.id === taskId ? { ...task, completed: !task.completed } : task
              );
              setTasks(updatedTasks);
              onUpdateTasks(schedule.id, dayOfWeek, classId, updatedTasks);
          };
      
          const handleDeleteTask = (taskId) => {
              const updatedTasks = tasks.filter(task => task.id !== taskId);
              setTasks(updatedTasks);
              onUpdateTasks(schedule.id, dayOfWeek, classId, updatedTasks);
          };
      
          if (!currentClass) return null;
      
          const meta = subjectMeta[currentClass.subject] || { color: '#cccccc', icon: 'ðŸ“š' };
      
          return (
              React.createElement(Modal, { isOpen: isOpen, onClose: onClose, title: `Tasks for ${currentClass.subject}` },
                  React.createElement('div', { className: "space-y-4" },
                      React.createElement('div', { className: "flex items-center gap-3 p-3 bg-zinc-100 dark:bg-zinc-800 rounded-lg" },
                          React.createElement('span', { className: "text-2xl" }, meta.icon),
                          React.createElement('h3', { className: "font-semibold text-lg text-zinc-800 dark:text-zinc-200" }, currentClass.subject)
                      ),
                      
                      React.createElement('div', { className: "space-y-2 max-h-64 overflow-y-auto pr-2" },
                          tasks.length > 0 ? tasks.map(task => (
                              React.createElement('div', { key: task.id, className: "flex items-center gap-3 p-2 rounded-md hover:bg-zinc-50 dark:hover:bg-zinc-800/50 group" },
                                 React.createElement('input',
                                      {
                                          type: "checkbox",
                                          id: `task-${task.id}`,
                                          checked: task.completed,
                                          onChange: () => handleToggleTask(task.id),
                                          className: "h-5 w-5 rounded border-zinc-300 text-primary focus:ring-primary"
                                      }),
                                  React.createElement('label', { htmlFor: `task-${task.id}`, className: `flex-1 text-sm ${task.completed ? 'line-through text-zinc-500' : 'text-zinc-800 dark:text-zinc-200'}` },
                                      task.text
                                  ),
                                  React.createElement('button', { onClick: () => handleDeleteTask(task.id), className: "text-zinc-400 hover:text-danger opacity-0 group-hover:opacity-100 transition-opacity" },
                                      React.createElement(Trash2, { size: 16 })
                                  )
                              )
                          )) : (
                              React.createElement('p', { className: "text-center text-zinc-500 dark:text-zinc-400 py-4" }, "No tasks for this class. Add one below!")
                          )
                      ),
      
                      React.createElement('div', { className: "flex gap-2 pt-4 border-t border-zinc-200 dark:border-zinc-700" },
                          React.createElement('input',
                              {
                                  type: "text",
                                  value: newTaskText,
                                  onChange: (e) => setNewTaskText(e.target.value),
                                  onKeyDown: (e) => { if (e.key === 'Enter') handleAddTask(); },
                                  placeholder: "Add a new task...",
                                  className: "flex-grow w-full rounded-lg border-zinc-300 dark:border-zinc-600 bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 shadow-sm focus:border-primary focus:ring-1 focus:ring-primary sm:text-sm"
                              }),
                          React.createElement('button',
                              {
                                  onClick: handleAddTask,
                                  className: "inline-flex items-center justify-center rounded-lg bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-hover focus:outline-none"
                              },
                              React.createElement(Plus, { size: 16, className: "mr-1"}), " Add"
                          )
                      )
                  )
              )
          );
      };
      
      const ArrivalTimeChart = ({ logs, schedules, period, gracePeriod }) => {
          const chartData = useMemo(() => {
              return logs
                  .filter(log => log.arrivalTime && (log.status === 'ON_TIME' || log.status === 'LATE' || log.status === 'EARLY'))
                  .map(log => {
                      const logDate = parseISO(log.date);
                      const scheduleForLog = getScheduleForDate(logDate, schedules);
                      if (!scheduleForLog) return null;
      
                      const dayOfWeek = getDay(logDate);
                      const rule = scheduleForLog.rules.find(r => r.dayOfWeek === dayOfWeek);
                      const firstPhysicalClass = rule?.classes?.filter(c => !c.isOnline).slice().sort((a,b) => a.startTime.localeCompare(b.startTime))[0];
                      
                      if (!firstPhysicalClass) return null;
      
                      const requiredTimeStr = firstPhysicalClass.startTime;
                      const requiredTimeMins = timeToMinutes(requiredTimeStr);
                      
                      return {
                          date: log.date,
                          name: format(parseISO(log.date), period === 'all' ? 'MMM d, yy' : 'MMM d'),
                          arrivalTime: timeToMinutes(log.arrivalTime),
                          requiredTime: requiredTimeMins,
                          graceTime: requiredTimeMins + gracePeriod,
                          status: log.status,
                          lateness: log.status === 'LATE' ? calculateLateness(log, schedules, gracePeriod) : 0,
                      };
                  })
                  .filter((item) => item !== null)
                  .sort((a, b) => a.date.localeCompare(b.date));
          }, [logs, schedules, period, gracePeriod]);
      
          const CustomTooltip = ({ active, payload, label }) => {
              if (active && payload && payload.length) {
                  const { arrivalTime, requiredTime, graceTime, status, lateness } = payload[0].payload;
                  
                  let statusText = STATUS_MAP[status].text;
                  let statusColor = CHART_COLORS.onTime; 
                  if (status === 'LATE') {
                      statusText = `Late by ${lateness} min`;
                      statusColor = CHART_COLORS.late;
                  }
      
                  return (
                      React.createElement('div', { className: "p-3 bg-zinc-800/80 dark:bg-black/60 backdrop-blur-sm rounded-lg shadow-lg border border-white/10 text-white" },
                        React.createElement('p', { className: "text-sm font-bold" }, label),
                        React.createElement('p', { className: "text-xs mt-2" }, "Arrival: ", React.createElement('span', { className: "font-semibold" }, timeAxisFormatter(arrivalTime))),
                        React.createElement('p', { className: "text-xs" }, "On-time by: ", React.createElement('span', { className: "font-semibold" }, timeAxisFormatter(requiredTime))),
                        React.createElement('p', { className: "text-xs" }, "Late after: ", React.createElement('span', { className: "font-semibold" }, timeAxisFormatter(graceTime))),
                        React.createElement('p', { className: "text-xs mt-2" }, "Status: ", React.createElement('span', { className: "font-semibold", style:{color: statusColor} }, statusText))
                      )
                  );
              }
              return null;
          };
      
          const CustomDot = (props) => {
              const { cx, cy, payload } = props;
              if (payload.status === 'LATE') {
                  return React.createElement(Dot, { cx: cx, cy: cy, r: 4, fill: CHART_COLORS.late });
              }
              if (payload.status === 'ON_TIME' || payload.status === 'EARLY') {
                  return React.createElement(Dot, { cx: cx, cy: cy, r: 4, fill: CHART_COLORS.onTime });
              }
              return null;
          };
      
          if (chartData.length === 0) {
              return (
                  React.createElement(Card, { className: "p-6" },
                      React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300 mb-2" }, "Arrival Time Trend"),
                      React.createElement('div', { className: "h-72 flex items-center justify-center" },
                          React.createElement('p', { className: "text-zinc-500" }, "No arrival data to display for this period.")
                      )
                  )
              )
          }
      
          return (
              React.createElement(Card, { className: "p-6" },
                  React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300 mb-2" }, "Arrival Time Trend"),
                   React.createElement('p', { className: "text-xs text-zinc-500 dark:text-zinc-400 mb-4" },
                      "Track your arrival times against your schedule's requirements. The space between the green and orange lines is your on-time window."
                  ),
                  React.createElement('div', { className: "w-full h-80" },
                      React.createElement(ResponsiveContainer, null,
                          React.createElement(ComposedChart, { data: chartData, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                              React.createElement(CartesianGrid, { strokeDasharray: "3 3", strokeOpacity: 0.2 }),
                              React.createElement(XAxis, { dataKey: "name", tick: { fill: 'rgb(113 113 122)', fontSize: 12 } }),
                              React.createElement(YAxis, 
                                  { 
                                      domain: ['dataMin - 15', 'dataMax + 15'],
                                      tickFormatter: timeAxisFormatter,
                                      tick: { fill: 'rgb(113 113 122)', fontSize: 12 },
                                      allowDecimals: false
                                  }),
                              React.createElement(Tooltip, { content: React.createElement(CustomTooltip) }),
                              React.createElement(Legend, { iconType: "plainline" }),
                              React.createElement(Line,
                                  {
                                      type: "monotone",
                                      dataKey: "requiredTime",
                                      stroke: CHART_COLORS.onTime,
                                      strokeWidth: 2,
                                      strokeDasharray: "5 5",
                                      dot: false,
                                      name: "On-time by",
                                      connectNulls: true
                                  }),
                               React.createElement(Line,
                                  {
                                      type: "monotone",
                                      dataKey: "graceTime",
                                      stroke: CHART_COLORS.late,
                                      strokeWidth: 2,
                                      strokeDasharray: "5 5",
                                      dot: false,
                                      name: "Late after",
                                      connectNulls: true
                                  }),
                               React.createElement(Line, 
                                  { 
                                      type: "monotone", 
                                      dataKey: "arrivalTime", 
                                      stroke: "var(--color-primary)",
                                      strokeWidth: 2,
                                      activeDot: { r: 6 },
                                      dot: React.createElement(CustomDot),
                                      name: "Actual Arrival",
                                      connectNulls: true
                                  })
                          )
                      )
                  )
              )
          );
      };
      
      const ChatWidget = ({ schedules, subjectMeta, settings }) => {
          const [messages, setMessages] = useState([]);
          const [input, setInput] = useState('');
          const chatContainerRef = useRef(null);
          const assistantName = settings.assistantName || 'Bros';
      
          useEffect(() => {
              setMessages([{
                  sender: 'bot',
                  text: `Hello! I'm your ${assistantName} assistant. Ask me anything about your schedule or tasks.`
              }]);
          }, [assistantName]);
      
          useEffect(() => {
              if (chatContainerRef.current) {
                  chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
              }
          }, [messages]);
      
          const handleSend = () => {
              if (input.trim() === '') return;
      
              const userMessage = { sender: 'user', text: input };
              const botResponseText = processQuestion(input, schedules, subjectMeta);
              const botMessage = {
                  sender: 'bot',
                  text: botResponseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>')
              };
      
              setMessages(prev => [...prev, userMessage, botMessage]);
              setInput('');
          };
      
          const handleSuggestionClick = (suggestion) => {
              setInput(suggestion);
              const userMessage = { sender: 'user', text: suggestion };
              const botResponseText = processQuestion(suggestion, schedules, subjectMeta);
              const botMessage = {
                  sender: 'bot',
                  text: botResponseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>')
              };
              setMessages(prev => [...prev, userMessage, botMessage]);
              setInput('');
          };
      
          const CHAT_SUGGESTIONS = [
              "What's my schedule today?",
              "à¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™à¸§à¸±à¸™à¸™à¸µà¹‰",
              "What's my next class?",
              "à¸à¸²à¸£à¸šà¹‰à¸²à¸™à¸¡à¸µà¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡",
              "Do I have Math tomorrow?",
              "à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¸„à¸“à¸´à¸•à¹„à¸«à¸¡",
          ];
      
          return (
              React.createElement(Card, { className: "w-full max-w-2xl mx-auto p-0 flex flex-col", style:{height: '70vh'} },
                   React.createElement('div', { className: "flex justify-between items-center p-4 border-b border-zinc-200 dark:border-zinc-700" },
                      React.createElement('h3', { className: "text-lg font-bold text-zinc-800 dark:text-zinc-200 flex items-center gap-2" },
                          React.createElement(Bot, { size: 20 }), " ", assistantName
                      )
                  ),
                  React.createElement('div', { ref: chatContainerRef, className: "flex-1 p-4 overflow-y-auto space-y-4" },
                      messages.map((msg, index) => (
                          React.createElement('div', { key: index, className: `flex items-start gap-3 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}` },
                              msg.sender === 'bot' && React.createElement(Bot, { size: 24, className: "text-primary flex-shrink-0 mt-1" }),
                              React.createElement('div',
                                  {
                                      className: `p-3 rounded-2xl max-w-md break-words text-sm ${
                                          msg.sender === 'user' 
                                          ? 'bg-primary text-white' 
                                          : 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200'
                                      }`,
                                      dangerouslySetInnerHTML: { __html: msg.text }
                                  }
                              ),
                               msg.sender === 'user' && React.createElement(User, { size: 24, className: "text-zinc-500 flex-shrink-0 mt-1" })
                          )
                      ))
                  ),
                  React.createElement('div', { className: "p-4 border-t border-zinc-200 dark:border-zinc-700" },
                       React.createElement('div', { className: "flex flex-wrap gap-2 mb-3" },
                          CHAT_SUGGESTIONS.map(suggestion => (
                              React.createElement('button', { key: suggestion, onClick: () => handleSuggestionClick(suggestion), className: "px-3 py-1.5 text-xs font-semibold rounded-full bg-zinc-200/80 dark:bg-zinc-700/80 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-300 dark:hover:bg-zinc-600 transition-colors" },
                                  suggestion
                              )
                          ))
                      ),
                      React.createElement('div', { className: "flex items-center gap-2" },
                          React.createElement('input',
                              {
                                  type: "text",
                                  value: input,
                                  onChange: e => setInput(e.target.value),
                                  onKeyDown: e => e.key === 'Enter' && handleSend(),
                                  placeholder: "Ask me anything...",
                                  className: "flex-grow w-full rounded-lg border-zinc-300 dark:border-zinc-600 bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 shadow-sm focus:border-primary focus:ring-1 focus:ring-primary sm:text-sm"
                              }),
                          React.createElement('button', { onClick: handleSend, className: "p-2.5 rounded-lg bg-primary text-white hover:bg-primary-hover transition-colors", "aria-label": "Send message" },
                              React.createElement(Send, { size: 20 })
                          )
                      )
                  )
              )
          );
      };
      
      const ChatView = ({ schedules, subjectMeta, settings }) => {
          const [messages, setMessages] = useState([]);
          const [input, setInput] = useState('');
          const chatContainerRef = useRef(null);
          const inputRef = useRef(null);
          const assistantName = settings.assistantName || 'Bros';
      
          const getInitialMessage = () => ({
              sender: 'bot',
              text: `Hello! I'm ${assistantName}. Ask me about your schedule, tasks, or anything else.`
          });
      
          useEffect(() => {
              setMessages([getInitialMessage()]);
          }, [assistantName]);
      
          useEffect(() => {
              if (chatContainerRef.current) {
                  chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
              }
          }, [messages]);
      
          const handleSend = (query) => {
              if (query.trim() === '') return;
      
              const userMessage = { sender: 'user', text: query };
              const botResponseText = processQuestion(query, schedules, subjectMeta);
              const botMessage = {
                  sender: 'bot',
                  text: botResponseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>')
              };
      
              setMessages(prev => [...prev, userMessage, botMessage]);
              setInput('');
              inputRef.current?.focus();
          };
      
          const handleNewChat = () => {
              setMessages([getInitialMessage()]);
              setInput('');
          };
          
          const CHAT_SUGGESTIONS = [
              "What is my schedule for today?",
              "Do I have any unfinished homework?",
              "When is my next class?",
              "Show me the full weekly schedule.",
              "Do I have Math class tomorrow?",
              "What were my tasks for Monday?",
          ];
      
          return (
              React.createElement('div', { className: "flex flex-row h-full w-full bg-white dark:bg-zinc-800 rounded-2xl shadow-soft overflow-hidden" },
                  React.createElement('aside', { className: "w-80 flex-shrink-0 bg-zinc-50 dark:bg-zinc-800/50 border-r border-zinc-200 dark:border-zinc-700/50 flex flex-col" },
                      React.createElement('div', { className: "p-4 border-b border-zinc-200 dark:border-zinc-700/50" },
                          React.createElement('h2', { className: "text-lg font-bold text-zinc-800 dark:text-zinc-200" }, "Classdy Assistant"),
                          React.createElement('p', { className: "text-sm text-zinc-500 dark:text-zinc-400" }, "Your schedule helper")
                      ),
                      React.createElement('div', { className: "p-4" },
                          React.createElement('button', { onClick: handleNewChat, className: "w-full flex items-center justify-center gap-2 p-2.5 rounded-lg bg-primary/10 text-primary font-semibold hover:bg-primary/20 transition-colors" },
                              React.createElement(PlusCircle, { size: 18 }), " New Chat"
                          )
                      ),
                      React.createElement('div', { className: "flex-1 overflow-y-auto p-4 pt-0 space-y-4" },
                          React.createElement('h3', { className: "text-sm font-semibold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider flex items-center gap-2" },
                              React.createElement(HelpCircle, { size: 16 }), " Quick Questions"
                          ),
                          React.createElement('div', { className: "space-y-2" },
                              CHAT_SUGGESTIONS.map(suggestion => (
                                  React.createElement('button', { key: suggestion, onClick: () => handleSend(suggestion), className: "w-full text-left text-sm p-2 rounded-lg text-zinc-700 dark:text-zinc-300 hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors" },
                                      suggestion
                                  )
                              ))
                          )
                      )
                  ),
      
                  React.createElement('main', { className: "flex-1 flex flex-col bg-white dark:bg-zinc-800" },
                      messages.length <= 1 ? (
                          React.createElement('div', { className: "flex-1 flex flex-col items-center justify-center text-center p-12" },
                              React.createElement('div', { className: "p-5 bg-primary/10 rounded-full mb-6" },
                                  React.createElement(MessageSquareText, { size: 48, strokeWidth: 1.5, className: "text-primary" })
                              ),
                              React.createElement('h2', { className: "text-3xl font-bold text-zinc-800 dark:text-zinc-200" },
                                  `Chat with ${assistantName}`
                              ),
                              React.createElement('p', { className: "text-zinc-500 dark:text-zinc-400 mt-3 max-w-md" },
                                  "Ask about your schedule, find out what homework is due, or check your next class time. I'm here to help you stay organized."
                              )
                          )
                      ) : (
                          React.createElement('div', { ref: chatContainerRef, className: "flex-1 p-6 space-y-6 overflow-y-auto" },
                              messages.map((msg, index) => (
                                   React.createElement('div', { key: index, className: `flex items-start gap-4 max-w-xl w-fit ${msg.sender === 'user' ? 'ml-auto' : ''}` },
                                      msg.sender === 'bot' && (
                                          React.createElement('div', { className: "w-9 h-9 rounded-full bg-primary flex items-center justify-center flex-shrink-0 mt-1" },
                                              React.createElement(Bot, { size: 20, className: "text-white" })
                                          )
                                      ),
                                      React.createElement('div',
                                          {
                                              className: `px-4 py-3 rounded-t-2xl text-sm shadow-sm ${
                                                  msg.sender === 'user' 
                                                  ? 'bg-primary text-white rounded-bl-2xl' 
                                                  : 'bg-zinc-100 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200 rounded-br-2xl'
                                              }`
                                          },
                                          React.createElement('div', { dangerouslySetInnerHTML: { __html: msg.text } })
                                      ),
                                      msg.sender === 'user' && (
                                          React.createElement('div', { className: "w-9 h-9 rounded-full bg-zinc-200 dark:bg-zinc-600 flex items-center justify-center flex-shrink-0 mt-1" },
                                              React.createElement(User, { size: 18, className: "text-zinc-600 dark:text-zinc-300" })
                                          )
                                      )
                                  )
                              ))
                          )
                      ),
                      
                      React.createElement('div', { className: "p-6 border-t border-zinc-200 dark:border-zinc-700/50" },
                          React.createElement('div', { className: "relative" },
                              React.createElement('input',
                                  {
                                      ref: inputRef,
                                      type: "text",
                                      value: input,
                                      onChange: e => setInput(e.target.value),
                                      onKeyDown: e => { if (e.key === 'Enter') handleSend(input); },
                                      placeholder: `Message ${assistantName}...`,
                                      className: "w-full rounded-xl border-zinc-300 dark:border-zinc-600 bg-zinc-100 dark:bg-zinc-700/50 text-zinc-900 dark:text-zinc-100 shadow-inner focus:border-primary focus:ring-1 focus:ring-primary py-3 pl-4 pr-14 text-base"
                                  }),
                              React.createElement('button', 
                                  { 
                                      onClick: () => handleSend(input), 
                                      className: "absolute right-2.5 top-1/2 -translate-y-1/2 p-2 rounded-lg bg-primary text-white hover:bg-primary-hover transition-colors disabled:bg-primary/50 disabled:cursor-not-allowed", 
                                      "aria-label": "Send message",
                                      disabled: !input.trim()
                                  },
                                  React.createElement(Send, { size: 20 })
                              )
                          )
                      )
                  )
              )
          );
      };
      
      const ScheduleEditor = ({ schedule, onSave, onCancel, subjectMeta }) => {
          const [editedSchedule, setEditedSchedule] = useState(JSON.parse(JSON.stringify(schedule)));
          const [allSubjects, setAllSubjects] = useState([]);
          
          useEffect(() => {
              const subjects = new Set();
              editedSchedule.rules.forEach(rule => {
                  rule.classes.forEach(c => subjects.add(c.subject));
              });
              Object.keys(subjectMeta).forEach(sub => subjects.add(sub));
              setAllSubjects(Array.from(subjects).filter(Boolean));
          }, [editedSchedule.rules, subjectMeta]);
      
          const handleScheduleInfoChange = (e) => {
              setEditedSchedule(prev => ({ ...prev, [e.target.name]: e.target.value }));
          };
      
          const handleRuleChange = (day, newClasses) => {
              setEditedSchedule(prev => ({
                  ...prev,
                  rules: prev.rules.map(rule => rule.dayOfWeek === day ? { ...rule, classes: newClasses } : rule)
              }));
          };
      
          const handleSave = () => {
              onSave(editedSchedule);
          };
          
          const inputClasses = "block w-full rounded-lg border-zinc-300 dark:border-zinc-600 bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 shadow-sm focus:border-primary focus:ring-1 focus:ring-primary sm:text-sm";
          const labelClasses = "block text-sm font-medium text-zinc-700 dark:text-zinc-300";
      
          const DayEditor = ({ day, rule, onChange, allSubjects, setAllSubjects }) => {
              const handleClassChange = (index, field, value) => {
                  const newClasses = [...rule.classes];
                  (newClasses[index])[field] = value;
                  onChange(rule.dayOfWeek, newClasses);
          
                  if (field === 'subject' && typeof value === 'string' && value.trim() && !allSubjects.includes(value)) {
                      setAllSubjects(prev => [...prev, value]);
                  }
              };
              
              const addClass = () => {
                  const newClass = { id: `class-${Date.now()}`, subject: '', startTime: '08:00', endTime: '09:00', tasks: [], isOnline: false };
                  onChange(rule.dayOfWeek, [...rule.classes, newClass]);
              };
          
              const removeClass = (index) => {
                  const newClasses = rule.classes.filter((_, i) => i !== index);
                  onChange(rule.dayOfWeek, newClasses);
              };
          
              return (
                  React.createElement('div', { className: "p-4 bg-zinc-100 dark:bg-zinc-800/50 rounded-lg" },
                      React.createElement('h4', { className: "font-semibold mb-3 text-zinc-800 dark:text-zinc-200" }, day),
                      React.createElement('div', { className: "space-y-3" },
                          rule.classes.map((cls, index) => (
                              React.createElement('div', { key: cls.id || index, className: "grid grid-cols-1 sm:grid-cols-10 gap-2 items-center" },
                                  React.createElement('div', { className: "sm:col-span-3" },
                                      React.createElement('label', { className: "text-xs sr-only" }, "Subject"),
                                       React.createElement('input', 
                                          { 
                                              type: "text",
                                              list: "subjects-datalist",
                                              value: cls.subject, 
                                              onChange: (e) => handleClassChange(index, 'subject', e.target.value), 
                                              className: inputClasses,
                                              placeholder: "Subject Name"
                                          })
                                  ),
                                  React.createElement('div', { className: "sm:col-span-2" },
                                      React.createElement('label', { className: "text-xs sr-only" }, "Start Time"),
                                      React.createElement('input', { type: "time", value: cls.startTime, onChange: (e) => handleClassChange(index, 'startTime', e.target.value), className: inputClasses, style:{colorScheme: 'dark'} })
                                  ),
                                   React.createElement('div', { className: "sm:col-span-2" },
                                       React.createElement('label', { className: "text-xs sr-only" }, "End Time"),
                                      React.createElement('input', { type: "time", value: cls.endTime, onChange: (e) => handleClassChange(index, 'endTime', e.target.value), className: inputClasses, style:{colorScheme: 'dark'} })
                                  ),
                                   React.createElement('div', { className: "sm:col-span-2 flex items-center justify-start sm:justify-center" },
                                      React.createElement('input',
                                          {
                                              type: "checkbox",
                                              id: `online-${cls.id}`,
                                              checked: !!cls.isOnline,
                                              onChange: (e) => handleClassChange(index, 'isOnline', e.target.checked),
                                              className: "h-4 w-4 rounded border-zinc-300 text-primary focus:ring-primary"
                                          }),
                                      React.createElement('label', { htmlFor: `online-${cls.id}`, className: "ml-2 text-sm text-zinc-600 dark:text-zinc-400" }, "Flipped")
                                  ),
                                  React.createElement('div', { className: "sm:col-span-1 flex justify-end" },
                                      React.createElement('button', { onClick: () => removeClass(index), className: "p-2 text-zinc-500 hover:text-danger rounded-md" }, React.createElement(Trash2, { size: 16 }))
                                  )
                              )
                          )),
                           React.createElement('datalist', { id: "subjects-datalist" },
                              allSubjects.map(sub => React.createElement('option', { key: sub, value: sub }))
                          ),
                          React.createElement('button', { onClick: addClass, className: "w-full text-sm flex items-center justify-center gap-1 p-2 rounded-md bg-primary/10 text-primary font-semibold hover:bg-primary/20" },
                              React.createElement(Plus, { size: 16 }), " Add Class"
                          )
                      )
                  )
              );
          };
      
          return (
              React.createElement('div', { className: "space-y-6" },
                  React.createElement('div', null,
                      React.createElement('h2', { className: "text-xl font-bold text-zinc-900 dark:text-zinc-100" }, schedule.name === "New Schedule" ? "Create New Schedule" : "Edit Schedule")
                  ),
                  
                  React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                      React.createElement('div', null,
                          React.createElement('label', { htmlFor: "name", className: labelClasses }, "Schedule Name"),
                          React.createElement('input', { type: "text", name: "name", id: "name", value: editedSchedule.name, onChange: handleScheduleInfoChange, className: inputClasses })
                      )
                  ),
                   React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                       React.createElement('div', null,
                          React.createElement('label', { htmlFor: "startDate", className: labelClasses }, "Start Date"),
                          React.createElement('input', { type: "date", name: "startDate", id: "startDate", value: editedSchedule.startDate || '', onChange: handleScheduleInfoChange, className: inputClasses, style:{colorScheme: 'dark'} })
                      ),
                       React.createElement('div', null,
                          React.createElement('label', { htmlFor: "endDate", className: labelClasses }, "End Date"),
                          React.createElement('input', { type: "date", name: "endDate", id: "endDate", value: editedSchedule.endDate || '', onChange: handleScheduleInfoChange, className: inputClasses, style:{colorScheme: 'dark'} })
                      )
                  ),
                  
                  React.createElement('div', { className: "space-y-4" },
                      DAYS_OF_WEEK.map(({ value, label }) => {
                           const rule = editedSchedule.rules.find(r => r.dayOfWeek === value);
                           return rule ? React.createElement(DayEditor, { key: value, day: label, rule: rule, onChange: handleRuleChange, allSubjects: allSubjects, setAllSubjects: setAllSubjects }) : null
                      })
                  ),
      
                  React.createElement('div', { className: "flex justify-end gap-3 pt-4 border-t border-zinc-200 dark:border-zinc-700" },
                       React.createElement('button', { onClick: onCancel, className: "rounded-lg border-none bg-zinc-200 dark:bg-zinc-700 py-2 px-4 text-sm font-medium text-zinc-800 dark:text-zinc-200 shadow-sm hover:bg-zinc-300 dark:hover:bg-zinc-600" }, "Cancel"),
                       React.createElement('button', { onClick: handleSave, className: "inline-flex justify-center rounded-lg border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-hover" }, "Save Schedule")
                  )
              )
          );
      };
      
      const Settings = (props) => {
          const [activeTab, setActiveTab] = useState('general');
      
          const TabButton = ({ icon, label, isActive, onClick }) => (
              React.createElement('button', { onClick: onClick, className: `flex items-center gap-3 w-full p-3 rounded-lg text-sm font-medium transition-colors ${isActive ? 'bg-primary/10 text-primary' : 'hover:bg-zinc-100 dark:hover:bg-zinc-800'}` },
                  icon,
                  React.createElement('span', null, label)
              )
          );
      
          const GeneralSettings = ({ settings, onSaveSettings, onShowMessage }) => {
              const handleNotificationToggle = async () => {
                  const currentlyEnabled = settings.notificationsEnabled;
          
                  if (!('Notification' in window) || !window.isSecureContext) {
                      onShowMessage("Notifications require a secure (HTTPS) connection and are not supported by your browser.");
                      return;
                  }
                  
                  if (Notification.permission === 'denied') {
                      onShowMessage("Notifications are blocked. Please enable them in your browser settings.");
                      return;
                  }
          
                  if (Notification.permission === 'default') {
                      const permission = await Notification.requestPermission();
                      if (permission === 'granted') {
                          onSaveSettings({ notificationsEnabled: true });
                          onShowMessage("Notifications enabled! You'll be reminded 10 minutes before class.");
                      } else {
                          onShowMessage("Notifications not enabled. You can change this later.");
                      }
                  } else if (Notification.permission === 'granted') {
                      onSaveSettings({ notificationsEnabled: !currentlyEnabled });
                      onShowMessage(currentlyEnabled ? "Notifications have been disabled." : "Notifications are now enabled.");
                  }
              };
          
              const inputClasses = "mt-1 block w-full rounded-lg border-zinc-300 dark:border-zinc-600 bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 shadow-sm focus:border-primary focus:ring-1 focus:ring-primary sm:text-sm";
              const labelClasses = "block text-sm font-medium text-zinc-700 dark:text-zinc-300";
              
              return (
                  React.createElement(Section, { title: "General Settings" },
                      React.createElement('div', null,
                          React.createElement('label', { htmlFor: "gracePeriod", className: labelClasses }, "Grace Period (minutes)"),
                          React.createElement('p', { className: "text-xs text-zinc-500 dark:text-zinc-400 mb-1" }, "How many minutes after the required time you can arrive before being marked as late."),
                          React.createElement('input', {
                              type: "number",
                              id: "gracePeriod",
                              value: settings.gracePeriod,
                              onChange: (e) => onSaveSettings({ gracePeriod: parseInt(e.target.value, 10) || 0 }),
                              className: inputClasses,
                              min: "0"
                          })
                      ),
                       React.createElement('div', null,
                          React.createElement('label', { htmlFor: "assistantName", className: labelClasses }, "Assistant Name"),
                          React.createElement('p', { className: "text-xs text-zinc-500 dark:text-zinc-400 mb-1" }, "Give your chat assistant a custom name."),
                          React.createElement('input', {
                              type: "text",
                              id: "assistantName",
                              value: settings.assistantName || '',
                              onChange: (e) => onSaveSettings({ assistantName: e.target.value }),
                              className: inputClasses,
                              placeholder: "e.g., Bros"
                          })
                      ),
                       React.createElement('div', null,
                          React.createElement('h4', { className: labelClasses }, "Notifications"),
                          React.createElement('p', { className: "text-xs text-zinc-500 dark:text-zinc-400 mb-2" }, "Get notified 10 minutes before a class starts."),
                          React.createElement('div', { className: "flex items-center justify-between p-3 rounded-lg bg-zinc-100 dark:bg-zinc-800/50" },
                              React.createElement('div', { className: "flex items-center gap-2" },
                                  React.createElement(Bell, { size: 18, className: settings.notificationsEnabled && Notification.permission === 'granted' ? 'text-primary' : 'text-zinc-500' }),
                                  React.createElement('span', { className: "font-medium text-zinc-800 dark:text-zinc-200" }, "Class Reminders")
                              ),
                               React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" },
                                  React.createElement('input', { type: "checkbox", checked: settings.notificationsEnabled && Notification.permission === 'granted', onChange: handleNotificationToggle, className: "sr-only peer" }),
                                  React.createElement('div', { className: "w-11 h-6 bg-zinc-200 dark:bg-zinc-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-zinc-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary" })
                              )
                          )
                      )
                  )
              );
          };
      
          const AppearanceSettings = ({ settings, onSaveSettings, subjectMeta, onReplaceAllSubjectMeta }) => {
              return (
                  React.createElement(React.Fragment, null,
                  React.createElement(Section, { title: "Appearance" },
                      React.createElement('div', null,
                          React.createElement('h4', { className: "block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2" }, "Theme"),
                           React.createElement('div', { className: "flex gap-2" },
                              (['light', 'dark', 'system']).map(theme => (
                                  React.createElement('button', { key: theme, onClick: () => onSaveSettings({ theme }), className: `px-4 py-2 rounded-lg text-sm capitalize font-semibold w-full transition-colors ${settings.theme === theme ? 'bg-primary text-white' : 'bg-zinc-200 dark:bg-zinc-700 text-zinc-800 dark:text-zinc-200'}` },
                                      theme
                                  )
                              ))
                          )
                      ),
                       React.createElement('div', null,
                          React.createElement('h4', { className: "block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2" }, "Accent Color"),
                          React.createElement('div', { className: "grid grid-cols-8 gap-2" },
                              ACCENT_COLORS.map(color => (
                                  React.createElement('button', { key: color, onClick: () => onSaveSettings({ accentColor: color }), className: `w-8 h-8 rounded-full transition-transform transform hover:scale-110 ${settings.accentColor === color ? 'ring-2 ring-offset-2 ring-primary dark:ring-offset-zinc-800' : ''}`, style: { backgroundColor: color }, "aria-label": `Set accent color to ${color}` })
                              ))
                          )
                      )
                  ),
                  React.createElement(SubjectManager, { subjectMeta: subjectMeta, onSave: onReplaceAllSubjectMeta })
                  )
              );
          };
      
          const SchedulesSettings = ({ schedules, onSaveSchedule, onDeleteSchedule, subjectMeta, onReplaceAllSubjectMeta }) => {
              const [editingScheduleId, setEditingScheduleId] = useState(null);
      
              const handleAddNew = () => {
                  const newId = `schedule-${Date.now()}`;
                  const newSchedule = {
                      id: newId,
                      name: 'New Schedule',
                      rules: [
                          { dayOfWeek: 1, classes: [] }, { dayOfWeek: 2, classes: [] },
                          { dayOfWeek: 3, classes: [] }, { dayOfWeek: 4, classes: [] },
                          { dayOfWeek: 5, classes: [] }, { dayOfWeek: 6, classes: [] },
                          { dayOfWeek: 0, classes: [] },
                      ],
                      startDate: '',
                      endDate: '',
                  };
                  onSaveSchedule(newSchedule);
                  setEditingScheduleId(newId);
              };
      
              const handleSaveFromEditor = (scheduleToSave) => {
                  const newSubjectMeta = { ...subjectMeta };
                  let metaWasUpdated = false;
                  scheduleToSave.rules.forEach(rule => {
                      rule.classes.forEach(c => {
                          if (c.subject && !newSubjectMeta[c.subject]) {
                              const usedColors = Object.values(newSubjectMeta).map(meta => meta.color);
                              const availableColor = PALETTE.find(p => !usedColors.includes(p)) || `#${Math.floor(Math.random()*16777215).toString(16)}`;
                              newSubjectMeta[c.subject] = { color: availableColor, icon: 'ðŸ“š' };
                              metaWasUpdated = true;
                          }
                      });
                  });
      
                  if (metaWasUpdated) {
                      onReplaceAllSubjectMeta(newSubjectMeta);
                  }
                  
                  onSaveSchedule(scheduleToSave);
                  setEditingScheduleId(null);
              };
      
              const handleCancel = () => {
                  const scheduleToCancel = schedules.find(s => s.id === editingScheduleId);
                  if(scheduleToCancel && scheduleToCancel.name === 'New Schedule' && scheduleToCancel.rules.every(r => r.classes.length === 0)) {
                      handleDelete(editingScheduleId);
                  }
                  setEditingScheduleId(null);
              }
              
              const handleDelete = (id) => {
                  if(schedules.length <= 1) {
                      alert("You cannot delete the last schedule.");
                      return;
                  }
                  if(window.confirm('Are you sure you want to delete this schedule? This cannot be undone.')) {
                      onDeleteSchedule(id);
                      if(editingScheduleId === id) {
                          setEditingScheduleId(null);
                      }
                  }
              };
      
              if (editingScheduleId) {
                  const scheduleToEdit = schedules.find(s => s.id === editingScheduleId);
                  if (scheduleToEdit) {
                      return (
                          React.createElement(ScheduleEditor, 
                              { 
                                  schedule: scheduleToEdit, 
                                  onSave: handleSaveFromEditor,
                                  onCancel: handleCancel,
                                  subjectMeta: subjectMeta
                              })
                      );
                  }
              }
      
              return (
                  React.createElement(Section, { title: "Schedules" },
                      React.createElement('div', { className: "space-y-3" },
                          schedules.map(schedule => (
                              React.createElement('div', { key: schedule.id, className: "flex items-center justify-between p-3 bg-zinc-100 dark:bg-zinc-800/50 rounded-lg" },
                                  React.createElement('div', null,
                                      React.createElement('p', { className: "font-semibold text-zinc-800 dark:text-zinc-200" }, schedule.name),
                                      React.createElement('p', { className: "text-xs text-zinc-500 dark:text-zinc-400" },
                                          schedule.startDate && schedule.endDate ? `${schedule.startDate} to ${schedule.endDate}` : 'No date range'
                                      )
                                  ),
                                  React.createElement('div', { className: "flex gap-2" },
                                       React.createElement('button', { onClick: () => setEditingScheduleId(schedule.id), className: "p-2 text-zinc-500 hover:text-primary rounded-md" }, React.createElement(Edit, { size: 16 })),
                                       React.createElement('button', { onClick: () => handleDelete(schedule.id), className: "p-2 text-zinc-500 hover:text-danger rounded-md" }, React.createElement(Trash2, { size: 16 }))
                                  )
                              )
                          ))
                      ),
                      React.createElement('button', { onClick: handleAddNew, className: "mt-4 w-full flex items-center justify-center gap-2 p-2.5 rounded-lg bg-primary/10 text-primary font-semibold hover:bg-primary/20" },
                          React.createElement(Plus, { size: 18 }), " Add New Schedule"
                      )
                  )
              );
          };
      
          const DataSettings = (props) => {
              const exportData = () => {
                  try {
                      const data = {
                          settings: props.settings,
                          schedules: props.schedules,
                          logs: props.logs,
                          subjectMeta: props.subjectMeta
                      };
                      const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(data, null, 2))}`;
                      const link = document.createElement('a');
                      link.href = jsonString;
                      link.download = `classdy_backup_${new Date().toISOString().split('T')[0]}.json`;
                      link.click();
                      props.onShowMessage("Data exported successfully!");
                  } catch(e) {
                      props.onShowMessage("Error exporting data.");
                  }
              };
      
              const importData = (event) => {
                  const file = event.target.files?.[0];
                  if (!file) return;
      
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      try {
                          const text = e.target?.result;
                          if (typeof text !== 'string') throw new Error("File could not be read");
                          const data = JSON.parse(text);
      
                          if (window.confirm("This will overwrite ALL current application data (schedules, logs, and settings). This cannot be undone. Are you sure?")) {
                              if (data.settings) props.onSaveSettings(data.settings);
                              if (data.schedules && Array.isArray(data.schedules)) {
                                 props.replaceAllSchedules(data.schedules);
                              }
                              if (data.subjectMeta) props.onReplaceAllSubjectMeta(data.subjectMeta);
                              if (data.logs && Array.isArray(data.logs)) {
                                  props.replaceAllLogs(data.logs);
                              }
                              props.onShowMessage("Data imported successfully!");
                          }
                      } catch (error) {
                          console.error("Failed to import data:", error);
                          props.onShowMessage("Failed to import data. Please check the file format.");
                      }
                  };
                  reader.readAsText(file);
                  event.target.value = '';
              };
      
              return (
                  React.createElement(Section, { title: "Data Management" },
                      React.createElement('div', null,
                           React.createElement('p', { className: "text-sm text-zinc-600 dark:text-zinc-400 mb-4" }, "Backup or restore your application data. This includes all schedules, logs, and settings."),
                          React.createElement('div', { className: "flex flex-col gap-3" },
                              React.createElement('button', { onClick: exportData, className: "w-full text-center p-2.5 rounded-lg bg-blue-500/10 text-blue-600 dark:text-blue-400 font-semibold hover:bg-blue-500/20" },
                                  "Export Data"
                              ),
                              React.createElement('label', { className: "w-full text-center p-2.5 rounded-lg bg-green-500/10 text-green-600 dark:text-green-400 font-semibold hover:bg-green-500/20 cursor-pointer" },
                                  "Import Data",
                                  React.createElement('input', { type: "file", accept: ".json", className: "hidden", onChange: importData })
                              )
                          )
                      )
                  )
              );
          };
      
          const renderContent = () => {
              switch (activeTab) {
                  case 'general': return React.createElement(GeneralSettings, props);
                  case 'appearance': return React.createElement(AppearanceSettings, props);
                  case 'schedules': return React.createElement(SchedulesSettings, props);
                  case 'data': return React.createElement(DataSettings, props);
                  default: return null;
              }
          };
      
        return (
          React.createElement(Modal, { isOpen: props.isOpen, onClose: props.onClose, title: "Settings", size: "2xl" },
              React.createElement('div', { className: "flex flex-col sm:flex-row gap-8" },
                  React.createElement('nav', { className: "w-full sm:w-48 flex-shrink-0 space-y-1" },
                      React.createElement(TabButton, { icon: React.createElement(SlidersHorizontal, { size: 18 }), label: "General", isActive: activeTab === 'general', onClick: () => setActiveTab('general') }),
                      React.createElement(TabButton, { icon: React.createElement(Palette, { size: 18 }), label: "Appearance", isActive: activeTab === 'appearance', onClick: () => setActiveTab('appearance') }),
                      React.createElement(TabButton, { icon: React.createElement(Calendar, { size: 18 }), label: "Schedules", isActive: activeTab === 'schedules', onClick: () => setActiveTab('schedules') }),
                      React.createElement(TabButton, { icon: React.createElement(Database, { size: 18 }), label: "Data", isActive: activeTab === 'data', onClick: () => setActiveTab('data') })
                  ),
                  React.createElement('div', { className: "flex-1 min-w-0" },
                      renderContent()
                  )
              )
          )
        );
      };
      
      const DayCard = ({ rule, subjectMeta, isToday, onDayClick, onOpenTaskModal }) => {
          const dayLabel = DAYS_OF_WEEK.find(d => d.value === rule.dayOfWeek)?.label || 'Unknown Day';
          const sortedClasses = [...rule.classes].sort((a,b) => a.startTime.localeCompare(b.startTime));
      
          return (
              React.createElement(Card, { className: `flex flex-col ${isToday ? 'ring-2 ring-primary' : ''}` },
                  React.createElement('div', { className: "p-4 border-b border-zinc-200 dark:border-zinc-700/50 flex justify-between items-center" },
                      React.createElement('h3', { className: "font-bold text-lg text-zinc-800 dark:text-zinc-200" }, dayLabel),
                      React.createElement('button', { onClick: onDayClick, className: "text-sm text-primary font-semibold flex items-center" },
                          "View ", React.createElement(ChevronRight, { size: 16 })
                      )
                  ),
                  React.createElement('div', { className: "flex-1 p-4 space-y-3" },
                      sortedClasses.length > 0 ? sortedClasses.map(cls => {
                          const meta = subjectMeta[cls.subject] || { color: '#cccccc', icon: 'ðŸ“š' };
                          const pendingTasks = cls.tasks.filter(t => !t.completed).length;
                          return (
                              React.createElement('div', { key: cls.id, className: "text-sm" },
                                  React.createElement('div', { className: "flex items-center justify-between" },
                                      React.createElement('div', { className: "flex items-center gap-2 truncate" },
                                          React.createElement('span', { className: "w-2 h-2 rounded-full flex-shrink-0", style:{backgroundColor: meta.color}}),
                                          React.createElement('span', { className: "font-semibold text-zinc-700 dark:text-zinc-300 truncate" }, cls.subject),
                                          cls.isOnline && React.createElement('span', { className: "text-xs text-primary font-medium" }, "(Flipped)")
                                      ),
                                      React.createElement('span', { className: "text-xs text-zinc-500 dark:text-zinc-400" }, formatTime(cls.startTime))
                                  ),
                                  pendingTasks > 0 && (
                                      React.createElement('button', { onClick: (e) => { e.stopPropagation(); onOpenTaskModal(rule.dayOfWeek, cls.id); }, className: "text-xs text-danger dark:text-red-400 font-semibold mt-1 flex items-center gap-1 pl-4" },
                                         React.createElement(NotebookText, { size: 12 }), ` ${pendingTasks} pending task${pendingTasks > 1 ? 's' : ''}`
                                      )
                                  )
                              )
                          )
                      }) : (
                          React.createElement('p', { className: "text-center text-zinc-500 dark:text-zinc-400 py-8" }, "Day Off")
                      )
                  )
              )
          );
      };
      
      const Timeline = ({ rule, subjectMeta, onOpenTaskModal }) => {
          const dayLabel = DAYS_OF_WEEK.find(d => d.value === rule.dayOfWeek)?.label || 'Unknown Day';
          const [currentTimePosition, setCurrentTimePosition] = useState(null);
          
          const sortedClasses = useMemo(() => {
              return [...rule.classes].sort((a, b) => a.startTime.localeCompare(b.startTime));
          }, [rule.classes]);
      
          const { hours, timelineStartHour, timelineTotalHours } = useMemo(() => {
              if (sortedClasses.length === 0) return { hours: [], timelineStartHour: 6, timelineTotalHours: 17 };
              
              const firstClassStart = timeToMinutes(sortedClasses[0].startTime);
              const lastClassEnd = timeToMinutes(sortedClasses[sortedClasses.length-1].endTime);
      
              const startHour = Math.max(0, Math.floor(firstClassStart / 60) - 1);
              const endHour = Math.min(23, Math.ceil(lastClassEnd / 60) + 1);
              
              const totalHours = endHour - startHour;
              const hourArray = Array.from({ length: totalHours + 1 }, (_, i) => i + startHour);
      
              return { hours: hourArray, timelineStartHour: startHour, timelineTotalHours: totalHours };
      
          }, [sortedClasses]);
          
          const hourHeightRem = 4;
      
          const updateCurrentTimeIndicator = () => {
              const now = new Date();
              const dayOfWeekNow = now.getDay();
              
              if (rule.dayOfWeek !== dayOfWeekNow) {
                  setCurrentTimePosition(null);
                  return;
              }
      
              const nowInMinutes = now.getHours() * 60 + now.getMinutes();
              const timelineStartMinutes = timelineStartHour * 60;
      
              if (nowInMinutes >= timelineStartMinutes && nowInMinutes <= (timelineStartHour + timelineTotalHours) * 60) {
                  const minutesFromStart = nowInMinutes - timelineStartMinutes;
                  const position = (minutesFromStart / (timelineTotalHours * 60)) * 100;
                  setCurrentTimePosition(position);
              } else {
                  setCurrentTimePosition(null);
              }
          };
          
          useEffect(() => {
              updateCurrentTimeIndicator();
              const interval = setInterval(updateCurrentTimeIndicator, 60000);
              return () => clearInterval(interval);
          }, [rule.dayOfWeek, timelineStartHour, timelineTotalHours]);
      
          return (
              React.createElement(Card, { className: "p-4 sm:p-6" },
                  React.createElement('h3', { className: "text-xl font-bold mb-6 text-zinc-800 dark:text-zinc-200" }, `${dayLabel}'s Schedule`),
                  sortedClasses.length > 0 ? (
                       React.createElement('div', { className: "relative flex" },
                           React.createElement('div', { className: "w-16 flex-shrink-0 text-right pr-4" },
                              hours.map(hour => (
                                   React.createElement('div', { key: `time-${hour}`, className: "text-xs font-mono text-zinc-500 dark:text-zinc-400 relative -top-2", style: { height: `${hourHeightRem}rem` } },
                                      hour === 12 ? '12 PM' : hour > 12 ? `${hour - 12} PM` : `${hour} AM`
                                  )
                              ))
                           ),
                           React.createElement('div', { className: "relative flex-1 border-l border-zinc-200 dark:border-zinc-700" },
                              hours.map((hour, index) => (
                                   React.createElement('div', { key: `line-${hour}`, className: `${index > 0 ? 'border-t border-dashed border-zinc-200 dark:border-zinc-700' : ''}`, style: { height: `${hourHeightRem}rem` } })
                               )),
                               currentTimePosition !== null && (
                                   React.createElement('div', { className: "absolute w-full z-10", style: { top: `${currentTimePosition}%` } },
                                       React.createElement('div', { className: "relative h-0" },
                                           React.createElement('div', { className: "absolute -top-[5px] left-[-5px] w-2.5 h-2.5 rounded-full bg-danger ring-2 ring-white dark:ring-zinc-800" }),
                                           React.createElement('div', { className: "h-px bg-danger w-full" })
                                       )
                                   )
                               ),
                              sortedClasses.map(cls => {
                                  const meta = subjectMeta[cls.subject] || { color: '#cccccc', icon: 'ðŸ“š' };
                                  const startMinutes = timeToMinutes(cls.startTime);
                                  const endMinutes = timeToMinutes(cls.endTime);
      
                                  const minutesFromStart = startMinutes - (timelineStartHour * 60);
                                  const durationMinutes = endMinutes - startMinutes;
                                  
                                  if (durationMinutes <= 0) return null;
      
                                  const topPercent = (minutesFromStart / (timelineTotalHours * 60)) * 100;
                                  const heightPercent = (durationMinutes / (timelineTotalHours * 60)) * 100;
                                  
                                  const pendingTasks = cls.tasks.filter(t => !t.completed).length;
      
                                  return (
                                      React.createElement('div',
                                          {
                                              key: cls.id,
                                              className: "absolute w-full pr-2",
                                              style: { top: `${topPercent}%`, height: `${heightPercent}%` }
                                          },
                                          React.createElement('div', { className: "h-full ml-2 p-2 rounded-lg flex flex-col", style: {backgroundColor: `${meta.color}20`, borderLeft: `3px solid ${meta.color}`}},
                                              React.createElement('p', { className: "font-bold text-sm", style: {color: meta.color}},
                                                  React.createElement('span', { className: "mr-2" }, meta.icon),
                                                  cls.subject,
                                                  cls.isOnline && React.createElement('span', { className: "font-medium text-xs" }, " (Flipped)")
                                              ),
                                              React.createElement('p', { className: "text-xs", style: {color: `${meta.color}B3`}}, `${formatTime(cls.startTime)} - ${formatTime(cls.endTime)}`),
                                              pendingTasks > 0 && (
                                                  React.createElement('button', 
                                                      { 
                                                          onClick: () => onOpenTaskModal(rule.dayOfWeek, cls.id), 
                                                          className: "mt-auto text-xs flex items-center gap-1 self-start px-1.5 py-0.5 rounded", 
                                                          style: {color: getContrastingTextColor(meta.color), backgroundColor: meta.color}
                                                      },
                                                      React.createElement(NotebookText, { size: 12 }),
                                                      React.createElement('span', null, `${pendingTasks} Task${pendingTasks > 1 ? 's' : ''}`)
                                                  )
                                              )
                                          )
                                      )
                                  )
                              })
                           )
                       )
                  ) : (
                       React.createElement('p', { className: "text-center text-zinc-500 dark:text-zinc-400 py-16" }, `No classes scheduled for ${dayLabel}.`)
                  )
              )
          );
      };
      
      const ScheduleView = ({ schedule, subjectMeta, onOpenTaskModal }) => {
          const [viewMode, setViewMode] = useState('week');
          const [selectedDay, setSelectedDay] = useState(new Date().getDay());
      
          const sortedRules = useMemo(() => {
              return [...schedule.rules].sort((a, b) => {
                  const dayA = a.dayOfWeek === 0 ? 7 : a.dayOfWeek;
                  const dayB = b.dayOfWeek === 0 ? 7 : b.dayOfWeek;
                  return dayA - dayB;
              });
          }, [schedule]);
      
          const handleDayClick = (day) => {
              setSelectedDay(day);
              setViewMode('day');
          };
          
          const selectedDayRule = useMemo(() => {
              return schedule.rules.find(rule => rule.dayOfWeek === selectedDay);
          }, [schedule, selectedDay]);
      
          return (
              React.createElement('div', null,
                  React.createElement('div', { className: "flex justify-center mb-6" },
                      React.createElement('div', { className: "p-1 bg-zinc-200 dark:bg-zinc-800 rounded-lg flex gap-1" },
                          React.createElement('button',
                              {
                                  onClick: () => setViewMode('week'),
                                  className: `px-4 py-1.5 rounded-md text-sm font-semibold flex items-center gap-2 transition-colors ${viewMode === 'week' ? 'bg-white dark:bg-zinc-700 text-primary' : 'text-zinc-600 dark:text-zinc-300'}`
                              },
                              React.createElement(Calendar, { size: 16 }), " Week"
                          ),
                          React.createElement('button',
                              {
                                  onClick: () => setViewMode('day'),
                                  className: `px-4 py-1.5 rounded-md text-sm font-semibold flex items-center gap-2 transition-colors ${viewMode === 'day' ? 'bg-white dark:bg-zinc-700 text-primary' : 'text-zinc-600 dark:text-zinc-300'}`
                              },
                              React.createElement(List, { size: 16 }), " Day"
                          )
                      )
                  ),
      
                  viewMode === 'week' ? (
                      React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-fade-in" },
                          sortedRules.map(rule => (
                              React.createElement(DayCard, 
                                  { 
                                      key: rule.dayOfWeek,
                                      rule: rule,
                                      subjectMeta: subjectMeta,
                                      onDayClick: () => handleDayClick(rule.dayOfWeek),
                                      onOpenTaskModal: onOpenTaskModal,
                                      isToday: rule.dayOfWeek === getDay(new Date())
                                  })
                          ))
                      )
                  ) : (
                      React.createElement('div', { className: "max-w-3xl mx-auto animate-fade-in" },
                          selectedDayRule && (
                              React.createElement(Timeline, 
                                  { 
                                      rule: selectedDayRule,
                                      subjectMeta: subjectMeta,
                                      onOpenTaskModal: onOpenTaskModal
                                  })
                          )
                      )
                  )
              )
          );
      };
      
      const DesktopNav = ({ options, activeTab, onTabChange, onAddLog, onOpenSettings }) => {
          const NavLink = ({ option, isActive, onClick }) => {
              const Icon = option.icon;
              return (
                  React.createElement('li', null,
                      React.createElement('button',
                          {
                              onClick: onClick,
                              className: `w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-semibold transition-colors
                          ${isActive
                              ? 'bg-primary/10 text-primary'
                              : 'text-zinc-600 dark:text-zinc-300 hover:bg-zinc-200/60 dark:hover:bg-zinc-800'
                          }`
                          },
                          React.createElement(Icon, { size: 20 }),
                          React.createElement('span', null, option.label)
                      )
                  )
              );
          };
      
          return (
              React.createElement('aside', { className: "w-64 flex-shrink-0 bg-white/50 dark:bg-zinc-900/50 border-r border-zinc-200 dark:border-zinc-700/50 flex flex-col" },
                  React.createElement('div', { className: "h-20 flex items-center px-6 border-b border-zinc-200 dark:border-zinc-700/50" },
                      React.createElement('h1', { className: "text-xl font-bold text-zinc-800 dark:text-zinc-200" }, "Classdy")
                  ),
                  React.createElement('nav', { className: "flex-1 p-4 space-y-2" },
                      React.createElement('ul', null,
                          options.map(option => (
                              React.createElement(NavLink, { key: option.value, option: option, isActive: activeTab === option.value, onClick: () => onTabChange(option.value) })
                          ))
                      )
                  ),
                  React.createElement('div', { className: "p-4 border-t border-zinc-200 dark:border-zinc-700/50 space-y-2" },
                       React.createElement('button', { onClick: onAddLog, className: "w-full flex items-center justify-center gap-2 p-2.5 rounded-lg bg-primary text-white font-semibold hover:bg-primary-hover transition-colors" },
                          React.createElement(Plus, { size: 18 }), " Add Log"
                      ),
                      React.createElement('button', { onClick: onOpenSettings, className: "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-semibold text-zinc-600 dark:text-zinc-300 hover:bg-zinc-200/60 dark:hover:bg-zinc-800 transition-colors" },
                          React.createElement(SettingsIcon, { size: 20 }),
                          React.createElement('span', null, "Settings")
                      )
                  )
              )
          );
      }
      
      const MobileNav = ({ options, activeTab, onTabChange }) => {
          return (
              React.createElement('footer', { className: "fixed bottom-0 left-0 right-0 h-16 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-lg border-t border-zinc-200 dark:border-zinc-800 z-40" },
                  React.createElement('nav', { className: "max-w-md mx-auto h-full flex justify-around items-center" },
                      options.map(option => {
                          const Icon = option.icon;
                          return (
                              React.createElement('button',
                                  {
                                      key: option.value,
                                      onClick: () => onTabChange(option.value),
                                      className: `flex flex-col items-center justify-center w-16 h-16 transition-colors rounded-lg ${activeTab === option.value ? 'text-primary' : 'text-zinc-500 dark:text-zinc-400'}`,
                                      "aria-label": option.label
                                  },
                                  React.createElement(Icon,
                                      {
                                          size: 24,
                                          strokeWidth: activeTab === option.value ? 2.5 : 2
                                      }
                                  ),
                                  React.createElement('span', { className: "text-[11px] font-semibold mt-1" }, option.label)
                              )
                          );
                      })
                  )
              )
          );
      };
      
      const Dashboard = ({ logsWithStatus, todayLog, todayStatus, onEditLog, schedules, activeSchedule, settings, holidays, onOpenTaskModal, subjectMeta }) => {
        const weeklyLogs = useMemo(() => {
            const now = new Date();
            const start = startOfWeek(now, { weekStartsOn: 1 });
            const end = endOfWeek(now, { weekStartsOn: 1 });
            return logsWithStatus.filter(log => {
                try {
                    return isWithinInterval(parseISO(log.date), { start, end });
                } catch {
                    return false;
                }
            });
        }, [logsWithStatus]);
    
        const lateness = useMemo(() => {
          if(todayLog && todayStatus === 'LATE') {
            return calculateLateness(todayLog, schedules, settings.gracePeriod);
          }
          return 0;
        }, [todayLog, todayStatus, schedules, settings.gracePeriod]);
        
        const TodayStatusCard = ({ todayStatus, todayLog, activeSchedule, onEditLog, lateness }) => {
            const { text, color, bg } = STATUS_MAP[todayStatus];
            
            const todayDayOfWeek = new Date().getDay();
            const todaySchedule = getScheduleForDate(new Date(), [activeSchedule]);
            const todayRule = todaySchedule?.rules.find(r => r.dayOfWeek === todayDayOfWeek);
            const requiredTime = todayRule?.classes?.filter(c => !c.isOnline).slice()?.sort((a,b) => a.startTime.localeCompare(b.startTime))[0]?.startTime;
        
            const Icon = useMemo(() => {
                switch (todayStatus) {
                    case 'ON_TIME': return CheckCircle;
                    case 'EARLY': return Award;
                    case 'LATE': return AlertCircle;
                    case 'ABSENT': return XCircle;
                    case 'DAY_OFF': return Coffee;
                    case 'HOLIDAY': return CalendarDays;
                    default: return Meh;
                }
            }, [todayStatus]);
        
            const getSubtitle = () => {
                if (todayStatus === 'LATE') return `You arrived ${lateness} minutes late.`;
                if (todayStatus === 'EARLY') return 'Great job, you were early!';
                if (todayStatus === 'ON_TIME') return 'Punctual and ready to go!';
                if (todayStatus === 'HOLIDAY') {
                    const holiday = todayLog?.status === 'HOLIDAY' ? ' (Marked)' : '';
                    return `It's a public holiday${holiday}.`;
                }
                if (todayStatus === 'DAY_OFF') return `No physical classes scheduled for today.`;
                return 'No entry recorded for today.';
            }
        
            return (
                React.createElement(Card, { className: `p-6 flex flex-col sm:flex-row items-start sm:items-center gap-4 ${bg}` },
                    React.createElement(Icon, { size: 48, className: `${color} flex-shrink-0` }),
                    React.createElement('div', { className: "flex-grow" },
                         React.createElement('p', { className: `text-2xl font-bold ${color}` }, text),
                         React.createElement('p', { className: `text-sm ${color} opacity-80 font-medium` }, getSubtitle())
                    ),
                    React.createElement('div', { className: "text-left sm:text-right w-full sm:w-auto mt-2 sm:mt-0 flex-shrink-0" },
                        React.createElement('p', { className: "font-semibold text-3xl text-zinc-800 dark:text-zinc-200" }, formatTime(todayLog?.arrivalTime || null)),
                        React.createElement('div', { className: "flex items-center justify-start sm:justify-end gap-4" },
                          React.createElement('p', { className: "text-sm text-zinc-500 dark:text-zinc-400" }, "Required: ", formatTime(requiredTime || null)),
                          todayLog && (
                            React.createElement('button', { onClick: onEditLog, className: "text-xs font-semibold text-primary/80 hover:text-primary flex items-center gap-1" },
                                React.createElement(Edit, { size: 12 }), " Edit"
                            )
                          )
                        )
                    )
                )
            )
        }
        
        const WeeklyOverviewWidget = ({ weeklyLogs, schedules, holidays }) => {
            const weekData = useMemo(() => {
                const now = new Date();
                const start = startOfWeek(now, { weekStartsOn: 1 });
                const end = endOfWeek(now, { weekStartsOn: 1 });
                const days = eachDayOfInterval({start, end});
        
                const logsByDate = weeklyLogs.reduce((acc, log) => {
                    acc[log.date] = log.status;
                    return acc;
                }, {});
                
                return days.map(day => {
                    const dateStr = format(day, 'yyyy-MM-dd');
                    const dayOfWeek = getDay(day);
                    const isHoliday = holidays.some(h => h.date === dateStr);
                    let status;
        
                    if (isHoliday) {
                        status = 'HOLIDAY';
                    } else if (logsByDate[dateStr]) {
                        status = logsByDate[dateStr];
                    } else {
                        const scheduleForDay = getScheduleForDate(day, schedules);
                        const rule = scheduleForDay?.rules.find(r => r.dayOfWeek === dayOfWeek);
                        if (!scheduleForDay) {
                            status = 'NO_SCHEDULE';
                        } else if (!rule || rule.classes.filter(c => !c.isOnline).length === 0) {
                            status = 'DAY_OFF';
                        } else {
                             const today = startOfDay(new Date());
                             status = day < today ? 'ABSENT' : 'NO_ENTRY';
                        }
                    }
                    
                    return {
                        name: format(day, 'E'),
                        status: status,
                        value: (status === 'NO_ENTRY' || status === 'DAY_OFF' || status === 'NO_SCHEDULE') ? 10 : 100
                    };
                })
            }, [weeklyLogs, schedules, holidays]);
        
            const getBarFillColor = (status) => {
                switch (status) {
                    case 'ON_TIME':
                    case 'EARLY': return CHART_COLORS.onTime;
                    case 'LATE': return CHART_COLORS.late;
                    case 'ABSENT': return CHART_COLORS.absent;
                    case 'HOLIDAY': return CHART_COLORS.holiday;
                    default: return CHART_COLORS.dayOff;
                }
            }
        
            const CustomTooltip = ({ active, payload }) => {
                if (active && payload && payload.length) {
                  const { status, name } = payload[0].payload;
                  const statusText = STATUS_MAP[status].text;
                  return (
                    React.createElement('div', { className: "p-2 bg-zinc-800 text-white rounded-md text-xs shadow-lg" },
                      `${name}: ${statusText}`
                    )
                  );
                }
                return null;
              };
        
            return (
                React.createElement(Card, { className: "p-6" },
                    React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300 flex items-center gap-2" }, React.createElement(CalendarDays, { size: 18, className: "text-zinc-400 dark:text-zinc-500" }),"Weekly Overview"),
                    React.createElement('div', { className: "h-28 mt-4" },
                        React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                            React.createElement(BarChart, { data: weekData, margin: { top: 5, right: 0, left: 0, bottom: 5 }, barCategoryGap: "20%" },
                                React.createElement(Tooltip, { content: React.createElement(CustomTooltip), cursor: { fill: 'rgba(161, 161, 170, 0.1)' } }),
                                React.createElement(Bar, { dataKey: "value", radius: [4, 4, 0, 0] },
                                    weekData.map((entry, index) => (
                                        React.createElement(Cell, { key: `cell-${index}`, fill: getBarFillColor(entry.status) })
                                    ))
                                ),
                                React.createElement(XAxis, { dataKey: "name", tickLine: false, axisLine: false, tick: { fill: 'rgb(113 113 122)', fontSize: 12 } })
                            )
                        )
                    )
                )
            );
        };
        
        const StreakCard = ({ logs, schedules, holidays }) => {
            const streak = useMemo(() => {
                return calculateOnTimeStreak(logs, schedules, holidays);
            }, [logs, schedules, holidays]);
        
             return (
                React.createElement(Card, { className: "p-6" },
                    React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300 flex items-center gap-2" }, React.createElement(TrendingUp, { size: 18, className: "text-zinc-400 dark:text-zinc-500"}), "On-Time Streak"),
                    React.createElement('div', { className: "flex items-baseline justify-center gap-2 mt-4" },
                        React.createElement('span', { className: "text-6xl font-bold text-primary" }, streak),
                        React.createElement('span', { className: "text-2xl font-semibold text-zinc-400 dark:text-zinc-500" }, "Days")
                    ),
                     React.createElement('p', { className: "text-center text-zinc-500 dark:text-zinc-400 text-sm mt-2" }, streak > 1 ? "Keep up the great work!" : "Let's build a new streak!")
                )
            );
        }
        
        const TodaySchedule = ({ schedule, subjectMeta, onOpenTaskModal }) => {
            const today = new Date();
            const dayOfWeek = getDay(today);
            
            const todayClasses = useMemo(() => {
                if (!schedule) return [];
                const rule = schedule.rules.find(r => r.dayOfWeek === dayOfWeek);
                return rule ? rule.classes.slice().sort((a, b) => a.startTime.localeCompare(b.startTime)) : [];
            }, [schedule, dayOfWeek]);
        
            if (!schedule || todayClasses.length === 0) {
                return (
                     React.createElement(Card, { className: "p-6" },
                        React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300 mb-4" }, "Today's Schedule"),
                        React.createElement('p', { className: "text-zinc-500 dark:text-zinc-400 text-center py-8" }, "No classes scheduled for today. Enjoy your day! ðŸŽ‰")
                     )
                )
            }
        
            return (
                React.createElement(Card, null,
                    React.createElement('div', { className: "p-6 border-b border-zinc-100 dark:border-zinc-800" },
                        React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300" }, "Today's Schedule"),
                        React.createElement('p', { className: "text-sm text-zinc-500 dark:text-zinc-400" }, format(today, 'EEEE, MMMM d'))
                    ),
                    React.createElement('ul', { className: "divide-y divide-zinc-100 dark:divide-zinc-800" },
                        todayClasses.map(cls => {
                            const meta = subjectMeta[cls.subject] || { color: '#cccccc', icon: 'ðŸ“š' };
                            const pendingTasks = cls.tasks.filter(t => !t.completed).length;
                            return (
                                React.createElement('li', { key: cls.id, className: "p-4 flex justify-between items-center hover:bg-zinc-50/50 dark:hover:bg-white/5 transition-colors duration-150" },
                                    React.createElement('div', { className: "flex items-center gap-4" },
                                       React.createElement('div', { className: "flex flex-col items-center" },
                                         React.createElement('span', 
                                           { 
                                               className: "text-2xl w-12 h-12 flex items-center justify-center rounded-full", 
                                               style: {backgroundColor: meta.color, color: getContrastingTextColor(meta.color)}
                                           },
                                             meta.icon
                                         )
                                       ),
                                       React.createElement('div', null,
                                           React.createElement('p', { className: "font-semibold text-zinc-800 dark:text-zinc-200" },
                                               cls.subject,
                                               cls.isOnline && React.createElement('span', { className: "text-xs ml-2 text-primary font-medium" }, "(Flipped)")
                                            ),
                                           React.createElement('p', { className: "text-sm text-zinc-500 dark:text-zinc-400" }, `${formatTime(cls.startTime)} - ${formatTime(cls.endTime)}`)
                                       )
                                    ),
                                    React.createElement('button',
                                        {
                                            onClick: () => onOpenTaskModal(dayOfWeek, cls.id),
                                            className: "flex items-center gap-2 text-zinc-500 dark:text-zinc-400 hover:text-primary dark:hover:text-blue-400 p-2 rounded-lg"
                                        },
                                        pendingTasks > 0 && React.createElement('span', { className: "px-2 py-0.5 text-xs font-bold rounded-full bg-danger text-white" }, pendingTasks),
                                        React.createElement('span', { className: "hidden sm:inline text-sm" }, pendingTasks > 0 ? 'Tasks' : 'View Tasks'),
                                        React.createElement(ChevronRight, { size: 18 })
                                    )
                                )
                            )
                        })
                    )
                )
            );
        };
    
        return (
          React.createElement('div', { className: "space-y-6" },
            React.createElement(TodayStatusCard, 
              { 
                todayStatus: todayStatus, 
                todayLog: todayLog, 
                onEditLog: () => todayLog && onEditLog(todayLog), 
                activeSchedule: activeSchedule, 
                lateness: lateness
              }),
            
            React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-2 gap-6" },
                React.createElement(TodaySchedule, { schedule: activeSchedule, subjectMeta: subjectMeta, onOpenTaskModal: onOpenTaskModal }),
                React.createElement('div', { className: "flex flex-col gap-6" },
                  React.createElement(WeeklyOverviewWidget, { weeklyLogs: weeklyLogs, schedules: schedules, holidays: holidays }),
                  React.createElement(StreakCard, { logs: logsWithStatus, schedules: schedules, holidays: holidays })
                )
            ),
      
             React.createElement('div', null,
              React.createElement('h3', { className: "text-xl font-semibold mb-4 ml-1" }, "Recent Activity"),
              React.createElement(Card, { className: "overflow-hidden" },
                  React.createElement('ul', { className: "divide-y divide-zinc-100 dark:divide-zinc-800" },
                      logsWithStatus.slice(0, 5).map(log => {
                          const {text, color, bg} = STATUS_MAP[log.status];
                          return (
                              React.createElement('li', { key: log.id, className: "p-4 flex justify-between items-center hover:bg-zinc-50/50 dark:hover:bg-white/5 transition-colors duration-150 group" },
                                  React.createElement('div', null,
                                      React.createElement('p', { className: "font-semibold text-zinc-800 dark:text-zinc-200" }, format(parseISO(log.date), 'EEEE, MMM d')),
                                      React.createElement('p', { className: "text-sm text-zinc-500 dark:text-zinc-400" }, `Arrival: ${formatTime(log.arrivalTime)}`)
                                  ),
                                 React.createElement('div', { className: "flex items-center gap-4" },
                                   React.createElement('span', { className: `px-3 py-1 text-xs font-bold rounded-full ${color} ${bg}` }, text),
                                   React.createElement('button', { onClick: () => onEditLog(log), className: "text-zinc-400 hover:text-primary opacity-0 group-hover:opacity-100 transition-opacity p-2 rounded-lg -m-2" },
                                      React.createElement(Edit, { size: 18 })
                                   )
                                 )
                              )
                          )
                      }),
                       logsWithStatus.length === 0 && (
                          React.createElement('li', { className: "p-8 text-center text-zinc-500 dark:text-zinc-400" },
                              "No recent activity to show. Add a log to get started!"
                          )
                      )
                  )
              )
             )
          )
        );
      };
      
      const Analytics = (props) => {
        const [period, setPeriod] = useState('month');
        const [customRange, setCustomRange] = useState({
            start: format(subDays(new Date(), 30), 'yyyy-MM-dd'),
            end: format(new Date(), 'yyyy-MM-dd'),
        });
    
        const handleCustomRangeChange = (e, part) => {
            setCustomRange(prev => ({...prev, [part]: e.target.value}));
        }
    
        const filteredLogs = useMemo(() => {
            const now = new Date();
            if (period === 'all') {
                return props.logsWithStatus;
            }
            if (period === 'custom') {
                if (!customRange.start || !customRange.end) return [];
                try {
                    const start = parseISO(customRange.start);
                    const end = parseISO(customRange.end);
                    end.setHours(23, 59, 59, 999);
                    return props.logsWithStatus.filter(log => {
                        try {
                            return isWithinInterval(parseISO(log.date), { start, end });
                        } catch { return false; }
                    });
                } catch {
                    return [];
                }
            }
            
            const start = period === 'week' ? startOfWeek(now, { weekStartsOn: 1 }) : startOfMonth(now);
            
            return props.logsWithStatus.filter(log => {
                try {
                     return isWithinInterval(parseISO(log.date), { start, end: now });
                } catch {
                    return false;
                }
            });
        }, [props.logsWithStatus, period, customRange]);
    
        const pieChartData = useMemo(() => {
            const counts = filteredLogs.reduce((acc, log) => {
                if (log.status === 'ON_TIME' || log.status === 'EARLY' || log.status === 'LATE' || log.status === 'ABSENT') {
                    const key = log.status === 'EARLY' ? 'ON_TIME' : log.status;
                    acc[key] = (acc[key] || 0) + 1;
                }
                return acc;
            }, {});
            
            return [
                { name: 'On Time & Early', value: counts.ON_TIME || 0 },
                { name: 'Late', value: counts.LATE || 0 },
                { name: 'Absent', value: counts.ABSENT || 0 },
            ].filter(d => d.value > 0);
        }, [filteredLogs]);
    
        const latenessData = useMemo(() => {
            const lateLogs = filteredLogs.filter(log => log.status === 'LATE');
            
            const weeks = {};
            
            lateLogs.forEach(log => {
                try {
                    const weekStartDate = format(startOfWeek(parseISO(log.date), { weekStartsOn: 1 }), 'yyyy-MM-dd');
                    const lateness = calculateLateness(log, props.schedules, props.settings.gracePeriod);
                    if (!weeks[weekStartDate]) {
                        weeks[weekStartDate] = { totalLateness: 0, count: 0 };
                    }
                    weeks[weekStartDate].totalLateness += lateness;
                    weeks[weekStartDate].count++;
                } catch (e) {
                    console.error("Error parsing date for lateness trend:", log.date, e);
                }
            });
            
            const trendData = Object.keys(weeks).sort().map(weekStartDate => ({
                name: format(parseISO(weekStartDate), 'MMM d'),
                avgLateness: Math.round(weeks[weekStartDate].totalLateness / weeks[weekStartDate].count)
            }));
    
            const totalLateness = lateLogs.reduce((sum, log) => sum + calculateLateness(log, props.schedules, props.settings.gracePeriod), 0);
            const overallAverage = lateLogs.length > 0 ? Math.round(totalLateness / lateLogs.length) : 0;
    
            return { trendData, overallAverage };
    
        }, [filteredLogs, props.schedules, props.settings.gracePeriod]);
        
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
              const data = payload[0];
              const name = label || data.name;
              const value = data.value;
              const unit = data.unit || '';
              
              return (
                React.createElement('div', { className: "p-3 bg-zinc-800/80 dark:bg-black/60 backdrop-blur-sm rounded-lg shadow-lg border border-white/10" },
                  React.createElement('p', { className: "text-sm font-bold text-white" }, name),
                  React.createElement('p', { className: "text-xs", style: { color: data.color || data.payload.fill } },
                    `${data.name}: ${value}${unit}`
                  )
                )
              );
            }
            return null;
          };
        
        const HeatmapLegend = () => {
            const legendItems = [
                { status: 'ON_TIME', label: 'On Time/Early' },
                { status: 'LATE', label: 'Late' },
                { status: 'ABSENT', label: 'Absent' },
                { status: 'HOLIDAY', label: 'Holiday' },
                { status: 'DAY_OFF', label: 'Day Off' },
            ];
            
            return (
                React.createElement('div', { className: "flex justify-center items-center gap-4 mt-4 flex-wrap" },
                    legendItems.map(item => (
                        React.createElement('div', { key: item.status, className: "flex items-center gap-1.5" },
                            React.createElement('div', { className: `w-3 h-3 rounded-sm ${getHeatmapColor(item.status)}` }),
                            React.createElement('span', { className: "text-xs text-zinc-600 dark:text-zinc-400" }, item.label)
                        )
                    ))
                )
            );
        };
        
        const CalendarHeatmap = ({ logsWithStatus, schedules, holidays, settings, period, customRange }) => {
            const logsByDate = useMemo(() => {
                return logsWithStatus.reduce((acc, log) => {
                    acc[log.date] = log;
                    return acc;
                }, {})
            }, [logsWithStatus]);
        
            const monthsToDisplay = useMemo(() => {
                const today = new Date();
                let rangeStart, rangeEnd;
                try {
                    switch(period) {
                        case 'week':
                            rangeStart = startOfWeek(today, { weekStartsOn: 1 });
                            rangeEnd = endOfWeek(today, { weekStartsOn: 1 });
                            break;
                        case 'month':
                            rangeStart = startOfMonth(today);
                            rangeEnd = endOfMonth(today);
                            break;
                        case 'custom':
                            rangeStart = parseISO(customRange.start);
                            rangeEnd = parseISO(customRange.end);
                            break;
                        case 'all':
                        default:
                            rangeStart = logsWithStatus.length > 0 ? parseISO(logsWithStatus[logsWithStatus.length - 1].date) : subDays(today, 90);
                            rangeEnd = today;
                    }
                } catch {
                    rangeStart = startOfMonth(today);
                    rangeEnd = endOfMonth(today);
                }
        
                const months = [];
                let currentMonth = startOfMonth(rangeStart);
                const lastMonth = startOfMonth(rangeEnd);
        
                while (isBefore(currentMonth, addMonths(lastMonth, 1))) {
                    months.push(currentMonth);
                    currentMonth = addMonths(currentMonth, 1);
                }
                return months;
        
            }, [period, customRange, logsWithStatus]);
            
            if (monthsToDisplay.length === 0) {
                return React.createElement(Card, { className: "p-6 text-center text-zinc-500" }, "No data for this period")
            }
        
            return (
                React.createElement(Card, { className: "p-6" },
                    React.createElement('div', { className: "space-y-8" },
                        monthsToDisplay.map(monthDate => {
                            const monthKey = format(monthDate, 'yyyy-MM');
                            const firstDayOfMonth = monthDate;
                            const lastDayOfMonth = endOfMonth(monthDate);
                            const daysInMonth = eachDayOfInterval({ start: firstDayOfMonth, end: lastDayOfMonth });
                            
                            let startingDayIndex = getDay(firstDayOfMonth);
                            if (startingDayIndex === 0) startingDayIndex = 7;
                            startingDayIndex -= 1;
        
                            const paddingDays = Array.from({ length: startingDayIndex }, (_, i) => i);
        
                            return (
                                React.createElement('div', { key: monthKey },
                                    React.createElement('h4', { className: "font-semibold text-lg mb-4 text-zinc-800 dark:text-zinc-200" }, format(monthDate, 'MMMM yyyy')),
                                    React.createElement('div', { className: "grid grid-cols-7 gap-1 sm:gap-2 text-center text-xs font-semibold text-zinc-500 dark:text-zinc-400 mb-2" },
                                        React.createElement('span', null, "Mon"), React.createElement('span', null, "Tue"), React.createElement('span', null, "Wed"), React.createElement('span', null, "Thu"), React.createElement('span', null, "Fri"), React.createElement('span', null, "Sat"), React.createElement('span', null, "Sun")
                                    ),
                                    React.createElement('div', { className: "grid grid-cols-7 gap-1 sm:gap-2" },
                                        paddingDays.map(i => React.createElement('div', { key: `pad-${i}` })),
                                        daysInMonth.map(day => {
                                            const dateStr = format(day, 'yyyy-MM-dd');
                                            const log = logsByDate[dateStr];
                                            const status = getStatus(dateStr, log?.arrivalTime || null, schedules, settings.gracePeriod, holidays, log?.statusTag);
                                            const tooltipText = `${format(day, 'MMM d')}: ${STATUS_MAP[status].text}`;
        
                                            return (
                                                React.createElement('div', { key: dateStr, className: "group relative" },
                                                    React.createElement('div', { className: `aspect-square rounded-lg flex items-center justify-center ${getHeatmapColor(status)}` },
                                                        React.createElement('span', { className: `text-xs ${status === 'DAY_OFF' || status === 'NO_ENTRY' ? 'text-zinc-400 dark:text-zinc-500' : 'text-white/80'}` }, format(day, 'd'))
                                                    ),
                                                    React.createElement('div', { className: "absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-max px-2 py-1 bg-zinc-800 text-white text-xs rounded-md opacity-0 pointer-events-none transition-opacity group-hover:opacity-100 z-10" },
                                                       tooltipText
                                                    )
                                                )
                                            );
                                        })
                                    )
                                )
                            );
                        })
                    ),
                    React.createElement(HeatmapLegend, null)
                )
            );
        };
        
        const PunctualityPieChart = ({ data }) => {
            const COLORS = [CHART_COLORS.onTime, CHART_COLORS.late, CHART_COLORS.absent, CHART_COLORS.early];
            const total = useMemo(() => data.reduce((sum, entry) => sum + entry.value, 0), [data]);
            
            return (
                React.createElement(Card, { className: "p-6 relative" },
                    React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300 mb-4" }, "Punctuality Breakdown"),
                    total === 0 ? (
                         React.createElement('div', { className: "h-64 flex items-center justify-center text-zinc-500" }, "No data for this period")
                    ) : (
                        React.createElement('div', { className: "w-full h-64" },
                            React.createElement(ResponsiveContainer, null,
                                React.createElement(PieChart, null,
                                    React.createElement(Pie, 
                                        { 
                                            data: data, 
                                            dataKey: "value", 
                                            nameKey: "name", 
                                            cx: "50%", 
                                            cy: "50%", 
                                            innerRadius: 65, 
                                            outerRadius: 90, 
                                            fill: "#8884d8", 
                                            paddingAngle: 5,
                                            labelLine: false, 
                                            label: ({ cx, cy, midAngle, innerRadius, outerRadius, percent }) => {
                                                 const radius = outerRadius + 15;
                                                 const x  = cx + radius * Math.cos(-midAngle * (Math.PI / 180));
                                                 const y = cy + radius * Math.sin(-midAngle * (Math.PI / 180));
                                                 return (percent > 0.05) ? React.createElement('text', { x: x, y: y, fill: "currentColor", className: "text-zinc-600 dark:text-zinc-400 text-xs", textAnchor: x > cx ? 'start' : 'end', dominantBaseline: "central" }, `${(percent * 100).toFixed(0)}%`) : null;
                                            }},
                                        data.map((entry, index) => React.createElement(Cell, { key: `cell-${index}`, fill: COLORS[index % COLORS.length], stroke: "transparent" }))
                                    ),
                                    React.createElement(Tooltip, { content: React.createElement(CustomTooltip) }),
                                    React.createElement(Legend, { iconType: "circle" })
                                )
                            )
                        )
                    ),
                    total > 0 && (
                        React.createElement('div', { className: "absolute inset-0 flex flex-col items-center justify-center pointer-events-none" },
                            React.createElement('span', { className: "text-4xl font-bold text-zinc-800 dark:text-zinc-200" }, total),
                            React.createElement('span', { className: "text-sm text-zinc-500 dark:text-zinc-400" }, "Tracked Days")
                        )
                    )
                )
            );
        };
        
        const LatenessTrendChart = ({ data, overallAverage }) => {
            return (
                React.createElement(Card, { className: "p-6" },
                    React.createElement('h3', { className: "font-semibold text-zinc-700 dark:text-zinc-300 mb-4" }, "Lateness by Week"),
                    data.length === 0 ? (
                         React.createElement('div', { className: "h-64 flex items-center justify-center text-zinc-500" }, "No late entries for this period")
                    ) : (
                        React.createElement('div', { className: "w-full h-64" },
                            React.createElement(ResponsiveContainer, null,
                                 React.createElement(RechartsAreaChart, { data: data, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                                    React.createElement('defs', null,
                                        React.createElement('linearGradient', { id: "colorLateness", x1: "0", y1: "0", x2: "0", y2: "1" },
                                            React.createElement('stop', { offset: "5%", stopColor: CHART_COLORS.late, stopOpacity: 0.7}),
                                            React.createElement('stop', { offset: "95%", stopColor: CHART_COLORS.late, stopOpacity: 0})
                                        )
                                    ),
                                    React.createElement(CartesianGrid, { strokeDasharray: "3 3", strokeOpacity: 0.2 }),
                                    React.createElement(XAxis, { dataKey: "name", tick:{fill: 'rgb(113 113 122)', fontSize: 12}}),
                                    React.createElement(YAxis, { unit: "m", tick:{fill: 'rgb(113 113 122)', fontSize: 12}}),
                                    React.createElement(Tooltip, { content: React.createElement(CustomTooltip), cursor:{fill: 'rgba(161, 161, 170, 0.1)'}}),
                                    React.createElement(Legend, { iconType: "circle", verticalAlign: "top", wrapperStyle:{paddingBottom: '15px'}}),
                                    React.createElement(ReferenceLine, { y: overallAverage, label: { value: 'Avg', position: 'insideTopRight', fill: CHART_COLORS.absent, fontSize: 10 }, stroke: CHART_COLORS.absent, strokeDasharray: "3 3" }),
                                    React.createElement(RechartsArea, { type: "monotone", dataKey: "avgLateness", stroke: CHART_COLORS.late, fill: "url(#colorLateness)", name: "Avg Lateness", unit: "m", strokeWidth: 2 })
                                )
                            )
                        )
                    )
                )
            )
        }
        
        const SegmentedControl = ({ options, value, onChange }) => (
            React.createElement('div', { className: "flex bg-zinc-200/80 dark:bg-zinc-800 rounded-lg p-1" },
                options.map(opt => (
                    React.createElement('button',
                        {
                            key: opt.value,
                            onClick: () => onChange(opt.value),
                            className: `px-3 py-1.5 rounded-md text-sm font-semibold flex items-center justify-center transition-colors w-full ${value === opt.value ? 'bg-white dark:bg-zinc-700 text-primary' : 'text-zinc-600 dark:text-zinc-300 hover:bg-white/50 dark:hover:bg-zinc-700/50'}`
                        },
                        opt.label
                    )
                ))
            )
        );
      
        return (
          React.createElement('div', { className: "space-y-6" },
              React.createElement('div', { className: "flex flex-col sm:flex-row justify-between sm:items-center gap-4" },
                       React.createElement('h2', { className: "text-2xl font-bold text-zinc-800 dark:text-zinc-200" }, "Detailed Reports"),
                       React.createElement('div', { className: "flex items-center gap-2 flex-wrap" },
                          React.createElement('div', { className: "w-full sm:w-auto" },
                              React.createElement(SegmentedControl,
                                  {
                                      options: [
                                          { label: 'Week', value: 'week' },
                                          { label: 'Month', value: 'month' },
                                          { label: 'All', value: 'all' },
                                          { label: 'Custom', value: 'custom' },
                                      ],
                                      value: period,
                                      onChange: setPeriod
                                  })
                          ),
      
                          period === 'custom' && (
                              React.createElement('div', { className: "flex items-center gap-2 animate-fade-in w-full sm:w-auto" },
                                  React.createElement('input', { type: "date", value: customRange.start, onChange: (e) => handleCustomRangeChange(e, 'start'), className: "p-1.5 h-9 rounded-lg text-sm bg-zinc-200 dark:bg-zinc-800 border-transparent focus:border-primary focus:ring-primary w-full", style:{colorScheme: 'dark'}}),
                                  React.createElement('span', { className: "text-zinc-500" }, "-"),
                                   React.createElement('input', { type: "date", value: customRange.end, onChange: (e) => handleCustomRangeChange(e, 'end'), className: "p-1.5 h-9 rounded-lg text-sm bg-zinc-200 dark:bg-zinc-800 border-transparent focus:border-primary focus:ring-primary w-full", style:{colorScheme: 'dark'}})
                              )
                          )
                       )
                  ),
      
              React.createElement(CalendarHeatmap, 
                  { 
                      logsWithStatus: props.logsWithStatus, 
                      schedules: props.schedules,
                      settings: props.settings, 
                      holidays: props.holidays, 
                      period: period,
                      customRange: customRange
                  }),
              React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-2 gap-6" },
                  React.createElement(PunctualityPieChart, { data: pieChartData }),
                  React.createElement(LatenessTrendChart, { data: latenessData.trendData, overallAverage: latenessData.overallAverage })
              )
          )
        );
      };
      
      const Overview = (props) => {
        const [period, setPeriod] = useState('month');
        const [customRange, setCustomRange] = useState({
            start: format(subDays(new Date(), 30), 'yyyy-MM-dd'),
            end: format(new Date(), 'yyyy-MM-dd'),
        });
    
        const handleCustomRangeChange = (e, part) => {
            setCustomRange(prev => ({...prev, [part]: e.target.value}));
        }
    
        const filteredLogs = useMemo(() => {
            const now = new Date();
            if (period === 'all') {
                return props.logsWithStatus;
            }
            if (period === 'custom') {
                if (!customRange.start || !customRange.end) return [];
                try {
                    const start = parseISO(customRange.start);
                    const end = parseISO(customRange.end);
                    end.setHours(23, 59, 59, 999);
                    return props.logsWithStatus.filter(log => {
                        try {
                            return isWithinInterval(parseISO(log.date), { start, end });
                        } catch { return false; }
                    });
                } catch {
                    return [];
                }
            }
            
            const start = period === 'week' ? startOfWeek(now, { weekStartsOn: 1 }) : startOfMonth(now);
            
            return props.logsWithStatus.filter(log => {
                try {
                     return isWithinInterval(parseISO(log.date), { start, end: now });
                } catch {
                    return false;
                }
            });
        }, [props.logsWithStatus, period, customRange]);
        
        const summaryStats = useMemo(() => {
            const trackedLogs = filteredLogs.filter(log => log.arrivalTime && ['ON_TIME', 'LATE', 'EARLY'].includes(log.status));
            if (trackedLogs.length === 0) {
                return {
                    avgArrivalTime: '--:--',
                    onTimePercentage: 'N/A',
                    earliestArrival: '--:--',
                    latestArrival: '--:--',
                };
            }
    
            const arrivalTimesInMinutes = trackedLogs.map(log => timeToMinutes(log.arrivalTime));
            const totalMinutes = arrivalTimesInMinutes.reduce((sum, mins) => sum + mins, 0);
            const avgMinutes = totalMinutes / arrivalTimesInMinutes.length;
    
            const earliest = Math.min(...arrivalTimesInMinutes);
            const latest = Math.max(...arrivalTimesInMinutes);
    
            const onTimeCount = filteredLogs.filter(log => log.status === 'ON_TIME' || log.status === 'EARLY').length;
            const totalDaysWithStatus = filteredLogs.filter(log => ['ON_TIME', 'LATE', 'EARLY', 'ABSENT'].includes(log.status)).length;
            
            const onTimePercentage = totalDaysWithStatus > 0 ? (onTimeCount / totalDaysWithStatus) * 100 : 0;
    
            return {
                avgArrivalTime: minutesToTime(avgMinutes),
                onTimePercentage: `${onTimePercentage.toFixed(0)}%`,
                earliestArrival: minutesToTime(earliest),
                latestArrival: minutesToTime(latest),
            };
        }, [filteredLogs]);
    
        const StatCard = ({ icon, title, value }) => {
            return (
                React.createElement(Card, { className: "p-4" },
                    React.createElement('div', { className: "flex items-center gap-4" },
                        React.createElement('div', { className: "p-3 bg-zinc-100 dark:bg-zinc-700/50 rounded-lg" },
                            icon
                        ),
                        React.createElement('div', null,
                            React.createElement('p', { className: "text-sm text-zinc-500 dark:text-zinc-400 font-medium" }, title),
                            React.createElement('p', { className: "text-2xl font-bold text-zinc-800 dark:text-zinc-200" }, value)
                        )
                    )
                )
            );
        };
    
        return (
            React.createElement('div', { className: "space-y-6" },
                React.createElement('div', { className: "flex flex-col sm:flex-row justify-between sm:items-center gap-4" },
                     React.createElement('h2', { className: "text-2xl font-bold text-zinc-800 dark:text-zinc-200" }, "Analytics Overview"),
                     React.createElement('div', { className: "flex items-center gap-2 flex-wrap" },
                        React.createElement('select',
                            {
                                value: period,
                                onChange: (e) => setPeriod(e.target.value),
                                className: "p-1.5 h-9 rounded-lg text-sm font-semibold capitalize transition-colors bg-zinc-200 dark:bg-zinc-800 border-transparent focus:border-primary focus:ring-primary"
                            },
                            React.createElement('option', { value: "week" }, "This Week"),
                            React.createElement('option', { value: "month" }, "This Month"),
                            React.createElement('option', { value: "all" }, "All Time"),
                            React.createElement('option', { value: "custom" }, "Custom Range")
                        ),
    
                        period === 'custom' && (
                            React.createElement('div', { className: "flex items-center gap-2 animate-fade-in" },
                                React.createElement('input', { type: "date", value: customRange.start, onChange: (e) => handleCustomRangeChange(e, 'start'), className: "p-1 h-9 rounded-lg text-sm bg-zinc-200 dark:bg-zinc-800 border-transparent focus:border-primary focus:ring-primary", style:{colorScheme: 'dark'}}),
                                React.createElement('span', { className: "text-zinc-500" }, "-"),
                                 React.createElement('input', { type: "date", value: customRange.end, onChange: (e) => handleCustomRangeChange(e, 'end'), className: "p-1 h-9 rounded-lg text-sm bg-zinc-200 dark:bg-zinc-800 border-transparent focus:border-primary focus:ring-primary", style:{colorScheme: 'dark'}})
                            )
                        )
                     )
                ),
    
                React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" },
                    React.createElement(StatCard, { icon: React.createElement(Clock, { size: 24, className: "text-primary"}), title: "Avg. Arrival", value: summaryStats.avgArrivalTime }),
                    React.createElement(StatCard, { icon: React.createElement(CheckCircle, { size: 24, className: "text-success"}), title: "On-Time Rate", value: summaryStats.onTimePercentage }),
                    React.createElement(StatCard, { icon: React.createElement(Sunrise, { size: 24, className: "text-blue-500"}), title: "Earliest Arrival", value: summaryStats.earliestArrival }),
                    React.createElement(StatCard, { icon: React.createElement(Sunset, { size: 24, className: "text-warning"}), title: "Latest Arrival", value: summaryStats.latestArrival })
                ),
                
                React.createElement(ArrivalTimeChart, 
                    { 
                        logs: filteredLogs,
                        schedules: props.schedules,
                        period: period,
                        gracePeriod: props.settings.gracePeriod
                    })
    
            )
        );
      };
      
      // =================================================================================
      // APP ROOT COMPONENT
      // =================================================================================
      
      function App() {
        const {
          settings,
          schedules,
          activeSchedule,
          logs,
          holidays,
          subjectMeta,
          updateSettings,
          saveSchedule,
          deleteSchedule,
          addOrUpdateLog,
          deleteLog,
          replaceAllLogs,
          replaceAllSchedules,
          replaceAllSubjectMeta,
          updateClassTasks
        } = useAppData();
      
        const [activeTab, setActiveTab] = useState('overview');
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [isAddLogModalOpen, setIsAddLogModalOpen] = useState(false);
        const [editingLog, setEditingLog] = useState(null);
        const [greeting, setGreeting] = useState('');
        const [taskModalState, setTaskModalState] = useState(null);
        const [notificationMessage, setNotificationMessage] = useState(null);
        
        const isDesktop = useMediaQuery('(min-width: 768px)');
      
        const NAV_OPTIONS = [
            {label: 'Overview', value: 'overview', icon: BarChartHorizontal},
            {label: 'Dashboard', value: 'dashboard', icon: LayoutGrid},
            {label: 'Schedule', value: 'schedule', icon: ListChecks},
            {label: 'Reports', value: 'reports', icon: AreaChart},
            {label: 'Chat', value: 'chat', icon: MessageCircle},
        ];
      
        useEffect(() => {
          applyTheme(settings.theme, settings.accentColor);
          
          if (schedules.length === 0) {
            setIsSettingsOpen(true);
          }
          setGreeting(getGreeting());
        }, []);
      
        useEffect(() => {
          applyTheme(settings.theme, settings.accentColor);
        }, [settings.theme, settings.accentColor]);
      
        useEffect(() => {
          let intervalId = null;
      
          const checkAndNotify = () => {
              if (!('Notification' in window) || !settings.notificationsEnabled || Notification.permission !== 'granted') {
                  return;
              }
      
              const now = new Date();
              
              let scheduleForToday = getScheduleForDate(now, schedules);
              if (!scheduleForToday && schedules.length > 0) {
                  scheduleForToday = schedules[0];
              }
              if (!scheduleForToday) return;
      
              const dayOfWeek = now.getDay();
              const todayRule = scheduleForToday.rules.find(r => r.dayOfWeek === dayOfWeek);
              if (!todayRule) return;
      
              const todaySchedule = todayRule.classes.filter(c => c.startTime && c.endTime);
      
              const notifiedClassesKey = `notified-${now.getFullYear()}-${now.getMonth()}-${now.getDate()}`;
              let notifiedToday = JSON.parse(sessionStorage.getItem(notifiedClassesKey) || '[]');
      
              const timeToDate = (timeStr) => {
                  const [h, m] = timeStr.split(':').map(Number);
                  const d = new Date();
                  d.setHours(h, m, 0, 0);
                  return d;
              };
      
              for (const cls of todaySchedule) {
                  const classTime = timeToDate(cls.startTime);
                  const diffMinutes = (classTime.getTime() - now.getTime()) / 60000;
                  
                  const notificationId = `${scheduleForToday.name}-${dayOfWeek}-${cls.startTime}-${cls.subject}`;
                  if (diffMinutes > 0 && diffMinutes <= 10 && !notifiedToday.includes(notificationId)) {
                      const icon = subjectMeta[cls.subject]?.icon || 'ðŸ“š';
                      new Notification(`${icon} Upcoming Class`, {
                          body: `${cls.subject} is starting at ${cls.startTime}.`,
                          tag: notificationId,
                      });
                      notifiedToday.push(notificationId);
                  }
              }
              sessionStorage.setItem(notifiedClassesKey, JSON.stringify(notifiedToday));
          };
      
          if (settings.notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
              checkAndNotify();
              intervalId = window.setInterval(checkAndNotify, 60000);
          }
      
          return () => {
              if (intervalId) clearInterval(intervalId);
          };
        }, [settings.notificationsEnabled, schedules, subjectMeta]);
      
        const handleShowNotification = (message) => {
          const id = Date.now();
          setNotificationMessage({ id, message });
          setTimeout(() => {
            setNotificationMessage(prev => (prev?.id === id ? null : prev));
          }, 3000);
        };
      
        const handleOpenAddLog = (log) => {
          setEditingLog(log || null);
          setIsAddLogModalOpen(true);
        };
      
        const handleOpenTaskModal = (day, classId) => {
          setTaskModalState({ day, classId });
        };
      
        const handleSaveSettings = (newSettings) => {
          if(newSettings.theme || newSettings.accentColor) {
              const themeToApply = newSettings.theme || settings.theme;
              const accentToApply = newSettings.accentColor || settings.accentColor;
              applyTheme(themeToApply, accentToApply);
          }
          updateSettings(newSettings);
        };
      
        const logsWithStatus = useMemo(() => {
          return logs.map(log => {
            const status = getStatus(log.date, log.arrivalTime, schedules, settings.gracePeriod, holidays, log.statusTag);
            return { ...log, status };
          });
        }, [logs, schedules, settings.gracePeriod, holidays]);
      
        const todayLog = useMemo(() => {
          const todayStr = new Date().toISOString().split('T')[0];
          return logsWithStatus.find(l => l.date === todayStr) || null;
        }, [logsWithStatus]);
      
        const todayStatus = todayLog?.status || getStatus(new Date().toISOString().split('T')[0], null, schedules, settings.gracePeriod, holidays);
      
        const renderContent = () => (
          schedules.length === 0 ? (
              React.createElement('div', { className: "text-center py-20 bg-white dark:bg-zinc-800/50 rounded-2xl shadow-soft" },
                React.createElement('h2', { className: "text-2xl font-semibold mb-2 text-zinc-800 dark:text-zinc-200" }, "Welcome to Classdy!"),
                React.createElement('p', { className: "text-zinc-600 dark:text-zinc-400 mb-8" }, "To get started, please create your first schedule in the settings."),
                React.createElement('button',
                  {
                    onClick: () => setIsSettingsOpen(true),
                    className: "bg-primary text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-primary-hover transition-transform transform hover:scale-105"
                  },
                  "Create Schedule"
                )
              )
            ) : (
              React.createElement('div', { className: "animate-fade-in h-full" },
                React.createElement('div', { role: "tabpanel", id: "panel-overview", hidden: activeTab !== 'overview' },
                  activeSchedule && React.createElement(Overview, { logsWithStatus: logsWithStatus, schedules: schedules, activeSchedule: activeSchedule, settings: settings, holidays: holidays })
                ),
                React.createElement('div', { role: "tabpanel", id: "panel-dashboard", hidden: activeTab !== 'dashboard' },
                  React.createElement(Dashboard,
                    {
                      logsWithStatus: logsWithStatus,
                      todayLog: todayLog,
                      todayStatus: todayStatus,
                      onEditLog: handleOpenAddLog,
                      schedules: schedules,
                      activeSchedule: activeSchedule,
                      settings: settings,
                      holidays: holidays,
                      onOpenTaskModal: handleOpenTaskModal,
                      subjectMeta: subjectMeta
                    })
                ),
                React.createElement('div', { role: "tabpanel", id: "panel-schedule", hidden: activeTab !== 'schedule' },
                  activeSchedule && (
                    React.createElement(ScheduleView,
                      {
                        schedule: activeSchedule,
                        subjectMeta: subjectMeta,
                        onOpenTaskModal: handleOpenTaskModal
                      })
                  )
                ),
                React.createElement('div', { role: "tabpanel", id: "panel-reports", hidden: activeTab !== 'reports' },
                   activeSchedule && React.createElement(Analytics, { logsWithStatus: logsWithStatus, schedules: schedules, activeSchedule: activeSchedule, settings: settings, holidays: holidays })
                ),
                React.createElement('div', { role: "tabpanel", id: "panel-chat", hidden: activeTab !== 'chat', className: "h-full" },
                    isDesktop ? (
                      React.createElement(ChatView,
                        {
                          schedules: schedules,
                          subjectMeta: subjectMeta,
                          settings: settings
                        })
                    ) : (
                      React.createElement(ChatWidget, 
                        { 
                          schedules: schedules, 
                          subjectMeta: subjectMeta,
                          settings: settings
                        })
                    )
                )
              )
          )
        );
        
        const renderModals = () => (
          React.createElement(React.Fragment, null,
            notificationMessage && (
                  React.createElement('div', { className: "fixed bottom-5 right-5 bg-zinc-800 text-white p-4 rounded-lg shadow-lg animate-fade-in" },
                      notificationMessage.message
                  )
            ),
      
            isSettingsOpen && (
              React.createElement(Settings,
                {
                  isOpen: isSettingsOpen,
                  onClose: () => setIsSettingsOpen(false),
                  settings: settings,
                  schedules: schedules,
                  activeSchedule: activeSchedule,
                  onSaveSettings: handleSaveSettings,
                  onSaveSchedule: saveSchedule,
                  onDeleteSchedule: deleteSchedule,
                  subjectMeta: subjectMeta,
                  onReplaceAllSubjectMeta: replaceAllSubjectMeta,
                  logs: logs,
                  replaceAllLogs: replaceAllLogs,
                  replaceAllSchedules: replaceAllSchedules,
                  onShowMessage: handleShowNotification
                })
            ),
            
            isAddLogModalOpen && (
              React.createElement(AddLogModal,
                {
                  isOpen: isAddLogModalOpen,
                  onClose: () => setIsAddLogModalOpen(false),
                  onSave: addOrUpdateLog,
                  onDelete: deleteLog,
                  log: editingLog
                })
            ),
            
            taskModalState && activeSchedule && (
                React.createElement(TaskModal,
                    {
                        isOpen: !!taskModalState,
                        onClose: () => setTaskModalState(null),
                        schedule: activeSchedule,
                        dayOfWeek: taskModalState.day,
                        classId: taskModalState.classId,
                        onUpdateTasks: updateClassTasks,
                        subjectMeta: subjectMeta
                    })
            )
          )
        );
      
        if (isDesktop) {
            return (
                React.createElement('div', { className: "h-screen w-screen flex bg-zinc-100 dark:bg-zinc-900 transition-colors duration-300 font-sans text-zinc-900 dark:text-zinc-50 antialiased" },
                    React.createElement(DesktopNav, 
                        { 
                            options: NAV_OPTIONS,
                            activeTab: activeTab,
                            onTabChange: setActiveTab,
                            onAddLog: () => handleOpenAddLog(),
                            onOpenSettings: () => setIsSettingsOpen(true)
                        }),
                    React.createElement('div', { className: "flex-1 flex flex-col overflow-hidden" },
                        React.createElement('header', { className: "h-20 flex-shrink-0 flex items-center px-8 border-b border-zinc-200 dark:border-zinc-700/50" },
                            React.createElement('div', null,
                                React.createElement('h1', { className: "text-3xl font-bold text-zinc-900 dark:text-zinc-100" }, greeting),
                                React.createElement('p', { className: "text-zinc-500 dark:text-zinc-400" }, "Here is your academic command center.")
                            )
                        ),
                        React.createElement('main', { className: "flex-1 overflow-y-auto p-8" },
                            renderContent()
                        )
                    ),
                    renderModals()
                )
            )
        }
      
        return (
          React.createElement('div', { className: "min-h-screen bg-zinc-100 dark:bg-zinc-900 transition-colors duration-300 flex flex-col" },
            React.createElement('header', { className: "sticky top-0 z-30 bg-zinc-100/80 dark:bg-zinc-900/80 backdrop-blur-lg border-b border-zinc-900/10 dark:border-white/10" },
              React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" },
                React.createElement('div', { className: "flex justify-between items-center py-4" },
                  React.createElement('div', null,
                    React.createElement('h1', { className: "text-2xl sm:text-3xl font-bold text-zinc-900 dark:text-zinc-100" }, greeting),
                    React.createElement('p', { className: "text-zinc-500 dark:text-zinc-400 text-sm" }, "Welcome to Classdy")
                  ),
                  React.createElement('div', { className: "flex items-center space-x-2" },
                    React.createElement('button',
                      {
                        onClick: () => handleOpenAddLog(),
                        className: "w-9 h-9 flex items-center justify-center rounded-full text-zinc-600 bg-zinc-200/70 hover:bg-zinc-200 dark:text-zinc-300 dark:bg-zinc-700/80 dark:hover:bg-zinc-700 transition-colors",
                        "aria-label": "Add new log"
                      },
                      React.createElement(Plus, { size: 22 })
                    ),
                    React.createElement('button',
                      {
                        onClick: () => setIsSettingsOpen(true),
                        className: "w-9 h-9 flex items-center justify-center rounded-full text-zinc-600 bg-zinc-200/70 hover:bg-zinc-200 dark:text-zinc-300 dark:bg-zinc-700/80 dark:hover:bg-zinc-700 transition-colors",
                        "aria-label": "Open settings"
                      },
                      React.createElement(SettingsIcon, { size: 20 })
                    )
                  )
                )
              )
            ),
      
            React.createElement('main', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow w-full mb-16" },
                renderContent()
            ),
            
            React.createElement(MobileNav, 
                { 
                    options: NAV_OPTIONS,
                    activeTab: activeTab,
                    onTabChange: setActiveTab
                }),
            
            renderModals()
          )
        );
      }
      
      // =================================================================================
      // RENDER APP
      // =================================================================================
      
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      
      const root = createRoot(rootElement);
      root.render(React.createElement(App));
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('Service Worker registered with scope: ', registration.scope);
          }).catch(error => {
            console.log('Service Worker registration failed: ', error);
          });
        });
      }
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
